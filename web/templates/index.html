<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetDevOpså·¥å…·ç®± - æ™ºèƒ½ç½‘ç»œè¿ç»´å¹³å°</title>
    <!-- å¼•å…¥ Bootstrap æ ·å¼ -->
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ Font Awesome å›¾æ ‡ -->
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* ç°ä»£åŒ–æ·±è‰²ä¸»é¢˜ */
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --secondary-color: #64748b;
            --background-color: #0f172a;
            --card-background: #1e293b;
            --card-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* å¹³æ»‘æ»šåŠ¨ */
        html {
            scroll-behavior: smooth;
        }

        /* å®¹å™¨æ ·å¼ */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* æ ‡é¢˜åŒºåŸŸ */
        .header-section {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
            background: linear-gradient(135deg, var(--primary-color), var(--info-color));
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            animation: fadeInUp 0.8s ease-out;
        }

        .header-section h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #ffffff, #cbd5e1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-section p {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.9);
            margin: 0;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary-color);
        }

        .card-header {
            background-color: rgba(79, 70, 229, 0.1);
            border-bottom: 1px solid var(--border-color);
            padding: 1.25rem 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-body {
            padding: 1.5rem;
            background-color: var(--card-background);
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            border-radius: 8px;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            text-transform: none;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
        }

        .btn-info {
            background-color: var(--info-color);
            border-color: var(--info-color);
        }

        .btn-info:hover {
            background-color: #2563eb;
            border-color: #2563eb;
        }

        .btn-outline-primary {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background-color: transparent;
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-outline-secondary {
            border-color: var(--secondary-color);
            color: var(--secondary-color);
            background-color: transparent;
        }

        .btn-outline-secondary:hover {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-outline-dark {
            border-color: var(--secondary-color);
            color: var(--secondary-color);
            background-color: transparent;
        }

        .btn-outline-dark:hover {
            background-color: var(--secondary-color);
            color: white;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .table {
            color: var(--text-primary);
            background-color: var(--card-background);
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 12px;
            overflow: hidden;
        }

        .table thead {
            background-color: rgba(79, 70, 229, 0.1);
            color: var(--text-primary);
        }

        .table th,
        .table td {
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.25rem;
            white-space: nowrap;
        }

        .table tbody tr {
            transition: var(--transition);
        }

        .table tbody tr:hover {
            background-color: rgba(79, 70, 229, 0.2);
            transform: translateX(4px);
        }

        .table-hover tbody tr:hover {
            background-color: rgba(79, 70, 229, 0.2);
        }

        /* ç¡®ä¿è¡¨æ ¼ä¸­æ‰€æœ‰æ–‡å­—åœ¨æ·±è‰²ä¸»é¢˜ä¸Šæ¸…æ™°å¯è§ */
        .table {
            color: var(--text-primary) !important;
        }

        .table td {
            color: var(--text-primary) !important;
        }

        .table .badge {
            color: var(--text-primary) !important;
        }

        /* è¦†ç›–é»˜è®¤çš„text-darkæ ·å¼ */
        .table .text-dark {
            color: var(--text-primary) !important;
        }

        /* ç¡®ä¿è¡Œæ‚¬åœæ—¶æ‰€æœ‰æ–‡å­—ä¿æŒç™½è‰² */
        .table tbody tr:hover {
            color: var(--text-primary) !important;
        }

        .table tbody tr:hover td {
            color: var(--text-primary) !important;
        }

        /* å¾½ç« æ ·å¼ */
        .badge {
            border-radius: 9999px;
            font-weight: 600;
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }

        .bg-success {
            background-color: var(--success-color) !important;
            color: #fff !important;
        }

        .bg-danger {
            background-color: var(--danger-color) !important;
            color: #fff !important;
        }

        .bg-warning {
            background-color: var(--warning-color) !important;
            color: var(--background-color) !important;
        }

        .bg-info {
            background-color: var(--info-color) !important;
            color: #fff !important;
        }

        .bg-secondary {
            background-color: var(--secondary-color) !important;
            color: #fff !important;
        }

        /* è¡¨å•æ ·å¼ */
        .form-control {
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            transition: var(--transition);
        }

        .form-control:focus {
            background-color: var(--background-color);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            color: var(--text-primary);
        }

        .form-control::placeholder {
            color: var(--text-muted);
        }

        .form-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* å¤é€‰æ¡†æ ·å¼ */
        .form-check-input {
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            transition: var(--transition);
        }

        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .form-check-input:focus {
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal-content {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            background-color: rgba(79, 70, 229, 0.1);
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .modal-title {
            color: var(--text-primary);
        }

        .modal-footer {
            background-color: var(--card-background);
            border-top: 1px solid var(--border-color);
        }

        /* æ»šåŠ¨å®¹å™¨ */
        .modal-table-container {
            max-height: 400px;
            overflow-y: auto;
            background-color: var(--card-background);
            border-radius: 8px;
        }

        .ai-report-container {
            max-height: 300px;
            overflow-y: auto;
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            transition: var(--transition);
        }

        .ai-report-container:hover {
            border-color: var(--primary-color);
        }

        /* AIæŠ¥å‘Šæ ·å¼ */
        .ai-report-container strong {
            color: var(--primary-color);
            font-weight: 600;
        }

        .ai-report-container h3 {
            font-size: 1rem;
            color: var(--info-color);
            margin: 1.2rem 0 0.8rem 0;
            padding-bottom: 0.3rem;
            border-bottom: 1px solid var(--border-color);
        }

        /* åŸå§‹å‘½ä»¤è¾“å‡ºæ ·å¼ */
        .raw-command-output {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background-color: var(--background-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            overflow-x: auto;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        /* é¡µè„šæ ·å¼ */
        footer {
            background-color: rgba(30, 41, 59, 0.5);
            border-top: 1px solid var(--border-color);
            padding: 2rem 0;
            margin-top: 3rem;
            text-align: center;
            border-radius: 12px 12px 0 0;
        }

        /* ç³»ç»Ÿå¥åº·å¡ç‰‡ */
        .health-card {
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            transition: var(--transition);
        }

        .health-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        .spinner-border {
            border-color: var(--primary-color);
            border-right-color: transparent;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .header-section h1 {
                font-size: 2rem;
            }

            .card {
                margin-bottom: 1.5rem;
            }

            .table th,
            .table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.875rem;
            }

            .stat-card {
                min-width: 100% !important;
                max-width: 100% !important;
            }

            .card-grid {
                grid-template-columns: 1fr !important;
            }
        }

        /* è®¾å¤‡æ¡£æ¡ˆå¡ */
        .stat-card {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.25rem;
            transition: var(--transition);
            min-width: 400px;
            max-width: 500px;
            margin: 0 auto;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }

        .stat-card .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .stat-card .stat-value {
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        .stat-card .row {
            margin-left: -8px;
            margin-right: -8px;
        }

        .stat-card .row > div {
            padding-left: 8px;
            padding-right: 8px;
        }

        .stat-card .row .col-6 {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .stat-card .row .col-6 span:first-child {
            white-space: nowrap;
        }

        .stat-card .row .col-6 span:last-child {
            white-space: nowrap;
            font-weight: 500;
        }

        .stat-card .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.3rem;
        }

        .stat-card .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* å¥åº·æ£€æŸ¥å¡ç‰‡ */
        .health-check-card {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
        }

        .health-check-card h6 {
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .health-check-card p {
            color: var(--text-secondary);
        }

        .health-check-card strong {
            color: var(--text-primary);
        }

        .health-check-card ul {
            color: var(--text-secondary);
            padding-left: 1.5rem;
        }

        .health-check-card li {
            margin-bottom: 0.5rem;
        }

        /* æœåŠ¡çŠ¶æ€åˆ—è¡¨ */
        .service-list .list-group-item {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: var(--transition);
        }

        .service-list .list-group-item:hover {
            background-color: var(--card-hover);
            border-color: var(--primary-color);
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }

        /* é€‰æ‹©è®¾å¤‡è®¡æ•° */
        #nornirSelectedCount {
            background-color: var(--primary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        /* å¡ç‰‡ç½‘æ ¼å¸ƒå±€ */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        /* è®¾å¤‡çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .status-dot.online {
            background-color: var(--success-color);
        }

        .status-dot.offline {
            background-color: var(--danger-color);
        }

        .status-dot.pending {
            background-color: var(--warning-color);
        }

        /* ä¿®å¤æ¨¡æ€æ¡†è¡¨æ ¼é•¿å†…å®¹æº¢å‡º */
        .modal-table-container .table td {
            white-space: normal;
            word-break: break-all;
        }

        /* ä¿®å¤å•ä¸ªè®¾å¤‡æ¡£æ¡ˆå¡æ¨¡æ€æ¡†å†…è¾¹è· */
        #singleDeviceCardContainer {
            padding: 1rem;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¯¼èˆª -->
        <nav class="navbar navbar-expand-lg navbar-dark mb-4" style="background-color: var(--card-background); border: 1px solid var(--border-color); border-radius: 12px;">
            <div class="container-fluid">
                <a class="navbar-brand" href="/" style="color: var(--text-primary); font-weight: 600;">NetDevOpså·¥å…·ç®±</a>
                <div class="navbar-nav">
                    <a class="nav-link active" href="/" style="color: var(--text-primary);">è®¾å¤‡ç®¡ç†</a>
                    <a class="nav-link" href="/cloud" style="color: var(--text-primary);">â˜ï¸ äº‘ç½‘ç»œæ¦‚å¿µ</a>
                    <a class="nav-link" href="/hybrid" style="color: var(--text-primary);">ğŸŒ æ··åˆäº‘å¹³å°</a>
                </div>
            </div>
        </nav>

        <!-- é¡µé¢æ ‡é¢˜åŒºåŸŸ -->
        <div class="header-section">
            <h1><i class="fas fa-toolbox me-3"></i>NetDevOpså·¥å…·ç®±ä»ªè¡¨ç›˜</h1>
            <p>æ™ºèƒ½ç½‘ç»œè®¾å¤‡è‡ªåŠ¨åŒ–è¿ç»´å¹³å°</p>
        </div>

        <!-- é¡¶éƒ¨å¡ç‰‡ç½‘æ ¼ -->
        <div class="row mb-4">
            <!-- APIæœåŠ¡çŠ¶æ€å¡ç‰‡ -->
            <div class="col-md-6 col-lg-4">
                <div class="card h-100">
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h5 class="card-title mb-1"><i class="fas fa-plug text-info me-2"></i>APIæœåŠ¡çŠ¶æ€</h5>
                                <p id="api-status" class="mb-0 text-muted">æ£€æŸ¥ä¸­...</p>
                            </div>
                            <button id="refresh-api-btn" onclick="checkApiStatus()" class="btn btn-sm btn-info">
                                <i class="fas fa-sync-alt me-1"></i>åˆ·æ–°
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AIæŠ¥å‘Šå¡ç‰‡ -->
            <div class="col-md-6 col-lg-8">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-line text-primary me-2"></i>AIå¤‡ä»½è¿ç»´æŠ¥å‘Š</h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center mb-3">
                            <div class="col-md-8">
                                <label for="reportDays" class="form-label">æŸ¥è¯¢è¿‘Nå¤©å¤‡ä»½ï¼ˆ1-30å¤©ï¼‰</label>
                                <input type="number" class="form-control" id="reportDays" value="7" min="1" max="30">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button id="generateReportBtn" class="btn btn-primary w-100">
                                    <i class="fas fa-robot me-1"></i>ç”ŸæˆAIæŠ¥å‘Š
                                </button>
                            </div>
                        </div>
                        
                        <p id="report-status" class="mb-2">
                            <span class="text-muted">ç‚¹å‡»ã€Œç”ŸæˆAIæŠ¥å‘Šã€è·å–è¿ç»´æ‘˜è¦</span>
                        </p>
                        
                        <div class="ai-report-container" id="aiReportContent">
                            <span class="text-muted text-center d-block py-4">æš‚æ— æŠ¥å‘Šå†…å®¹ï¼Œè¯·å…ˆç”Ÿæˆ</span>
                        </div>
                        
                        <div class="mt-2 small text-muted" id="reportGenerateTime"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç³»ç»Ÿå¥åº·æ£€æŸ¥å¡ç‰‡ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-heartbeat text-danger me-2"></i>ç³»ç»Ÿå¥åº·çŠ¶æ€</h5>
                        <button id="checkSystemHealthBtn" class="btn btn-primary">
                            <i class="fas fa-stethoscope me-1"></i>ä¸€é”®æ£€æŸ¥ç³»ç»Ÿå¥åº·
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- æ•´ä½“å¥åº·ç»“è®º -->
                        <div class="health-card mb-4" id="systemHealthSummary">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold">æ•´ä½“çŠ¶æ€ï¼š<span class="text-muted">æœªæ£€æŸ¥</span></span>
                                <span class="small text-muted">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æ£€æŸ¥</span>
                            </div>
                        </div>

                        <!-- ç³»ç»ŸæŒ‡æ ‡å’ŒæœåŠ¡çŠ¶æ€ -->
                        <div class="row">
                            <!-- ç³»ç»Ÿçº§åˆ«æŒ‡æ ‡ -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header py-2">
                                        <h6 class="mb-0"><i class="fas fa-tachometer-alt text-warning me-2"></i>ç³»ç»Ÿçº§åˆ«æŒ‡æ ‡</h6>
                                    </div>
                                    <div class="card-body" id="systemMetricsContent">
                                        <div class="text-center text-muted py-4">
                                            <small>æš‚æ— æŒ‡æ ‡æ•°æ®ï¼Œè¯·å…ˆæ‰§è¡Œæ£€æŸ¥</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- æœåŠ¡å¥åº·çŠ¶æ€ -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header py-2">
                                        <h6 class="mb-0"><i class="fas fa-server text-success me-2"></i>æœåŠ¡å¥åº·çŠ¶æ€</h6>
                                    </div>
                                    <div class="card-body" id="serviceStatusContent">
                                        <div class="text-center text-muted py-4">
                                            <small>æš‚æ— æœåŠ¡çŠ¶æ€ï¼Œè¯·å…ˆæ‰§è¡Œæ£€æŸ¥</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¡£æ¡ˆå¡æ¨¡æ€æ¡† -->
        <div class="modal fade" id="deviceCardsModal" tabindex="-1" aria-labelledby="deviceCardsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deviceCardsModalLabel">
                            <i class="fas fa-id-card text-primary me-2"></i>è®¾å¤‡æ¡£æ¡ˆå¡æ€»è§ˆ
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="card-grid" id="modalDeviceCardsContainer">
                            <div class="text-center text-muted py-4">
                                <small>åŠ è½½æ¡£æ¡ˆå¡ä¸­...</small>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å•ä¸ªè®¾å¤‡æ¡£æ¡ˆå¡ä¸“ç”¨æ¨¡æ€æ¡† -->
        <div class="modal fade" id="singleDeviceCardModal" tabindex="-1" aria-labelledby="singleDeviceCardModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" style="max-width: 540px;">
                <div class="modal-content">
                    <div class="modal-header" style="padding: 0.75rem 1rem;">
                        <h5 class="modal-title" id="singleDeviceCardModalLabel">
                            <i class="fas fa-id-card text-primary me-2"></i>è®¾å¤‡æ¡£æ¡ˆå¡
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" style="padding: 0;">
                        <div id="singleDeviceCardContainer">
                            <div class="text-center text-muted py-4">
                                <small>åŠ è½½æ¡£æ¡ˆå¡ä¸­...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¥åº·æ£€æŸ¥ç»“æœæ¨¡æ€æ¡† -->
        <div class="modal fade" id="healthCheckResultModal" tabindex="-1" aria-labelledby="healthCheckResultModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="healthCheckResultModalLabel">
                            <i class="fas fa-heartbeat text-danger me-2"></i>å¥åº·æ£€æŸ¥ç»“æœ - <span id="healthCheckDeviceName">æœªçŸ¥è®¾å¤‡</span>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="healthCheckResultContainer">
                            <div class="text-center text-muted py-4">
                                <small>åŠ è½½å¥åº·æ£€æŸ¥ç»“æœä¸­...</small>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è®¾å¤‡åˆ—è¡¨å¡ç‰‡ -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-network-wired text-secondary me-2"></i>è®¾å¤‡çŠ¶æ€æ€»è§ˆ</h5>
            </div>
            <div class="card-body">
                <!-- Norniræ‰¹é‡å¹¶å‘æ£€æŸ¥åŒºåŸŸ -->
                <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between mb-4 p-3 bg-opacity-10 rounded-lg" style="background-color: rgba(79, 70, 229, 0.1);">
                    <div class="d-flex align-items-center">
                        <input type="checkbox" id="nornirSelectAll" class="form-check-input me-2">
                        <label for="nornirSelectAll" class="form-label mb-0">å…¨é€‰è®¾å¤‡</label>
                        <span id="nornirSelectedCount" class="ms-3">å·²é€‰ï¼š0 å°</span>
                    </div>
                    <div class="d-flex gap-2">
                        <button id="nornirBatchCheckBtn" class="btn btn-primary" disabled>
                            <i class="fas fa-rocket me-1"></i>Nornirå¹¶å‘å¥åº·æ£€æŸ¥
                        </button>
                        <button id="viewAllCardsBtn" class="btn btn-primary">
                            <i class="fas fa-id-card me-1"></i>ä¸€é”®æŸ¥çœ‹æ‰€æœ‰æ¡£æ¡ˆå¡
                        </button>
                    </div>
                </div>

                <!-- å“åº”å¼è¡¨æ ¼ -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <!-- Norniræ‰¹é‡é€‰æ‹©åˆ— -->
                                <th>
                                    <input type="checkbox" id="nornirTableSelectAll" class="form-check-input">
                                </th>
                                <th>è®¾å¤‡å</th>
                                <th>IPåœ°å€</th>
                                <th>è®¾å¤‡ç±»å‹</th>
                                <th>è®¾å¤‡çŠ¶æ€</th>
                                <th>å¤‡ä»½çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for device in devices %}
                            <tr>
                                <!-- Norniræ‰¹é‡é€‰æ‹©åˆ— -->
                                <td>
                                    <input type="checkbox" class="form-check-input nornirDeviceCheckbox" data-hostname="{{ device.device_name }}">
                                </td>
                                <td>{{ device.device_name }}</td>
                                <td>{{ device.host }}</td>
                                <td>
                                    <span class="badge bg-info text-dark">{{ device.device_type }}</span>
                                </td>
                                <!-- è®¾å¤‡çŠ¶æ€åˆ— -->
                                <td class="device-status">
                                    {% if device.status == 'åœ¨çº¿' %}
                                    <span class="status-indicator">
                                        <span class="status-dot online"></span>
                                        <span class="badge bg-success">åœ¨çº¿</span>
                                    </span>
                                    {% else %}
                                    <span class="status-indicator">
                                        <span class="status-dot offline"></span>
                                        <span class="badge bg-danger">ç¦»çº¿</span>
                                    </span>
                                    {% endif %}
                                </td>
                                <!-- å¤‡ä»½çŠ¶æ€åˆ— -->
                                <td class="backup-status">
                                    <span class="badge bg-secondary">æœªå¤‡ä»½</span>
                                </td>
                                <!-- æ“ä½œåˆ— -->
                                <td>
                                    <div class="d-flex gap-2">
                                        <!-- å¥åº·æ£€æŸ¥æŒ‰é’® -->
                                        <button class="btn btn-sm btn-outline-primary health-check-btn" data-hostname="{{ device.device_name }}">
                                            <i class="fas fa-heartbeat me-1"></i>å¥åº·æ£€æŸ¥
                                        </button>
                                        <!-- å¤‡ä»½æŒ‰é’® -->
                                        <button class="btn btn-sm btn-outline-secondary backup-btn" data-hostname="{{ device.device_name }}">
                                            <i class="fas fa-save me-1"></i>å¤‡ä»½è®¾å¤‡
                                        </button>
                                        <!-- æŸ¥çœ‹å¤‡ä»½å†å²æŒ‰é’® -->
                                        <button class="btn btn-sm btn-outline-dark backup-history-btn" data-hostname="{{ device.device_name }}">
                                            <i class="fas fa-history me-1"></i>å¤‡ä»½å†å²
                                        </button>
                                        <!-- æŸ¥çœ‹æ¡£æ¡ˆå¡æŒ‰é’® -->
                                        <button class="btn btn-sm btn-outline-info view-card-btn" data-hostname="{{ device.device_name }}">
                                            <i class="fas fa-id-card me-1"></i>æŸ¥çœ‹æ¡£æ¡ˆå¡
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- é¡µè„šåŒºåŸŸ -->
        <footer class="mt-5 py-4">
            <div class="container">
                <div class="text-center">
                    <p class="mb-0">
                        <i class="fas fa-code text-primary me-1"></i>ç‰ˆæœ¬ 0.5.0 | åŸºäºFlaskæ„å»º | 
                        <i class="fas fa-desktop text-info me-1"></i>è®¾å¤‡æ€»æ•°: {{ devices|length }} å°
                    </p>
                    <p class="small text-muted mt-1">
                        Â© 2026 NetDevOps Toolbox | æ™ºèƒ½ç½‘ç»œè¿ç»´è§£å†³æ–¹æ¡ˆ
                    </p>
                </div>
            </div>
        </footer>
    </div>

    <!-- å¤‡ä»½å†å²æ¨¡æ€æ¡† -->
    <div class="modal fade" id="backupHistoryModal" tabindex="-1" aria-labelledby="backupHistoryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="backupHistoryModalLabel">
                        <i class="fas fa-history text-primary me-2"></i>è®¾å¤‡å¤‡ä»½å†å² - <span id="modalDeviceName">æœªçŸ¥è®¾å¤‡</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- å¤‡ä»½å†å²æŸ¥è¯¢æ¡ä»¶ -->
                    <div class="row mb-3 align-items-center">
                        <div class="col-md-4">
                            <label for="historyLimit" class="form-label">æŸ¥è¯¢è®°å½•æ•°ï¼ˆ1-100ï¼‰</label>
                            <input type="number" class="form-control" id="historyLimit" value="20" min="1" max="100">
                        </div>
                        <div class="col-md-8 d-flex align-items-end justify-content-md-end">
                            <button id="refreshHistoryBtn" class="btn btn-info">
                                <i class="fas fa-sync-alt me-1"></i>åˆ·æ–°å¤‡ä»½å†å²
                            </button>
                        </div>
                    </div>

                    <!-- å¤‡ä»½å†å²è¡¨æ ¼ -->
                    <div class="modal-table-container">
                        <table class="table table-hover table-sm">
                            <thead class="sticky-top" style="background-color: var(--card-background); color: var(--text-primary); border-bottom: 1px solid var(--border-color);">
                                <tr>
                                    <th>è®°å½•ID</th>
                                    <th>è®¾å¤‡å</th>
                                    <th>å¤‡ä»½è·¯å¾„</th>
                                    <th>å¤‡ä»½æ—¶é—´</th>
                                    <th>å¤‡ä»½çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody id="backupHistoryTableBody">
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">è¯·ç‚¹å‡»ã€Œåˆ·æ–°å¤‡ä»½å†å²ã€è·å–è®°å½•</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- å¤‡ä»½å†å²ç»Ÿè®¡ä¿¡æ¯ -->
                    <div class="mt-3 small text-muted">
                        <span id="historyCountInfo">æ€»è®°å½•æ•°ï¼š0 æ¡</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Nornirå¹¶å‘æ£€æŸ¥ç»“æœæ¨¡æ€æ¡† -->
    <div class="modal fade" id="nornirCheckResultModal" tabindex="-1" aria-labelledby="nornirCheckResultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nornirCheckResultModalLabel">
                        <i class="fas fa-chart-pie text-primary me-2"></i>Nornirå¹¶å‘å¥åº·æ£€æŸ¥ç»“æœ
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- å¹¶å‘æ£€æŸ¥æ±‡æ€»ä¿¡æ¯ -->
                    <div class="card mb-3" style="background-color: rgba(79, 70, 229, 0.1);">
                        <div class="card-body">
                            <div class="d-flex flex-wrap gap-4 justify-content-between align-items-center">
                                <span class="fw-bold">æ±‡æ€»ç»“æœï¼š</span>
                                <div class="d-flex gap-3">
                                    <span id="nornirSuccessCount" class="text-success"><i class="fas fa-check-circle me-1"></i>æˆåŠŸï¼š0 å°</span>
                                    <span id="nornirFailedCount" class="text-danger"><i class="fas fa-times-circle me-1"></i>å¤±è´¥ï¼š0 å°</span>
                                    <span id="nornirTotalCount" class="text-muted"><i class="fas fa-server me-1"></i>æ€»è®¡ï¼š0 å°</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å¹¶å‘æ£€æŸ¥è¯¦ç»†ç»“æœè¡¨æ ¼ -->
                    <div class="modal-table-container" style="max-height: 600px;">
                        <table class="table table-hover table-sm">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 120px;">è®¾å¤‡å</th>
                                    <th style="width: 100px;">æ£€æŸ¥çŠ¶æ€</th>
                                    <th style="flex: 1;">åŸå§‹å‘½ä»¤è¾“å‡º</th>
                                    <th style="width: 180px;">æ£€æŸ¥æ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody id="nornirCheckResultTableBody">
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">æš‚æ— æ£€æŸ¥ç»“æœï¼Œè¯·å…ˆæ‰§è¡Œå¹¶å‘æ£€æŸ¥</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript æ ¸å¿ƒå…¬å…±æ–¹æ³• + æ‰€æœ‰åŠŸèƒ½é€»è¾‘ï¼ˆæ— é‡å¤ã€æ— æŠ¥é”™ï¼‰ -->
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        // å…¨å±€æ¨¡æ€æ¡†å®ä¾‹ï¼ˆç»Ÿä¸€åˆå§‹åŒ–ï¼Œé¿å…é‡å¤ï¼‰
        let modalInstances = {
            deviceCardsModal: null,
            singleDeviceCardModal: null,
            healthCheckResultModal: null,
            backupHistoryModal: null,
            nornirCheckResultModal: null
        };

        // DOMåŠ è½½å®Œæˆååˆå§‹åŒ–æ‰€æœ‰æ¨¡æ€æ¡†
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–æ‰€æœ‰æ¨¡æ€æ¡†
            modalInstances.deviceCardsModal = new bootstrap.Modal(document.getElementById('deviceCardsModal'));
            modalInstances.singleDeviceCardModal = new bootstrap.Modal(document.getElementById('singleDeviceCardModal'));
            modalInstances.healthCheckResultModal = new bootstrap.Modal(document.getElementById('healthCheckResultModal'));
            modalInstances.backupHistoryModal = new bootstrap.Modal(document.getElementById('backupHistoryModal'));
            modalInstances.nornirCheckResultModal = new bootstrap.Modal(document.getElementById('nornirCheckResultModal'));

            // åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½
            initApiStatusCheck();
            initBackupFunction();
            initHealthCheckFunction();
            initDeviceCardFunction();
            initBackupHistoryFunction();
            initAiReportFunction();
            initSystemHealthFunction();
            initNornirBatchCheckFunction();

            // åˆå§‹æ£€æŸ¥APIçŠ¶æ€
            checkApiStatus();
        });

        // 1. APIçŠ¶æ€æ£€æŸ¥
        function checkApiStatus() {
            const statusElement = document.getElementById('api-status');
            const refreshBtn = document.getElementById('refresh-api-btn');

            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>åˆ·æ–°ä¸­...';
            statusElement.innerHTML = '<div class="status-indicator"><span class="status-dot pending"></span><span class="badge bg-warning">æ£€æŸ¥ä¸­...</span></div>';

            fetch('/api/service_status')
                .then(response => response.json().then(data => ({ response, data })))
                .then(({ response, data }) => {
                    if (!response.ok) throw new Error(`è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
                    if (!data || !data.status) {
                        statusElement.innerHTML = '<div class="status-indicator"><span class="status-dot offline"></span><span class="badge bg-secondary">æœªçŸ¥çŠ¶æ€</span></div>';
                        return;
                    }

                    if (data.status === 'healthy') {
                        statusElement.innerHTML = '<div class="status-indicator"><span class="status-dot online"></span><span class="badge bg-success">æœåŠ¡æ­£å¸¸</span></div>';
                    } else {
                        const errorMsg = data.message || 'æœªçŸ¥å¼‚å¸¸';
                        statusElement.innerHTML = `<div class="status-indicator"><span class="status-dot offline"></span><span class="badge bg-warning">æœåŠ¡å¼‚å¸¸: ${errorMsg}</span></div>`;
                    }
                })
                .catch(error => {
                    statusElement.innerHTML = '<div class="status-indicator"><span class="status-dot offline"></span><span class="badge bg-danger">è¯·æ±‚å¤±è´¥</span></div>';
                    console.error('APIçŠ¶æ€æ£€æŸ¥å¤±è´¥è¯¦æƒ…ï¼š', error);
                })
                .finally(() => {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>åˆ·æ–°';
                });
        }

        // åˆå§‹åŒ–APIçŠ¶æ€æ£€æŸ¥æŒ‰é’®
        function initApiStatusCheck() {
            document.getElementById('refresh-api-btn').addEventListener('click', checkApiStatus);
        }

        // 2. è®¾å¤‡å¤‡ä»½åŠŸèƒ½
        function initBackupFunction() {
            document.querySelectorAll('.backup-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const hostname = this.getAttribute('data-hostname');
                    const backupCell = this.closest('tr').querySelector('.backup-status');
                    const originalText = this.textContent;

                    this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>å¤‡ä»½ä¸­...';
                    this.disabled = true;
                    backupCell.innerHTML = '<div class="status-indicator"><span class="status-dot pending"></span><span class="badge bg-warning">å¤‡ä»½ä¸­</span></div>';

                    fetch(`/api/backup/${hostname}`)
                        .then(response => response.json().then(data => ({ response, data })))
                        .then(({ response, data }) => {
                            if (!response.ok) throw new Error(data.message || `å¤‡ä»½è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
                            if (data.status && data.status === 'æˆåŠŸ') {
                                const successHtml = `
                                    <div class="status-indicator">
                                        <span class="status-dot online"></span>
                                        <span class="badge bg-success">å¤‡ä»½æˆåŠŸ</span>
                                    </div>
                                    <small class="text-muted d-block mt-1">
                                        å¤‡ä»½è·¯å¾„ï¼š${data.backup_path || 'æœªçŸ¥è·¯å¾„'}
                                    </small>
                                `;
                                backupCell.innerHTML = successHtml;
                            } else {
                                backupCell.innerHTML = `<div class="status-indicator"><span class="status-dot offline"></span><span class="badge bg-danger">å¤‡ä»½å¤±è´¥ï¼š${data.message || 'æœªçŸ¥é”™è¯¯'}</span></div>`;
                            }
                        })
                        .catch(error => {
                            backupCell.innerHTML = `<div class="status-indicator"><span class="status-dot offline"></span><span class="badge bg-danger">âŒ ${error.message}</span></div>`;
                            console.error('å¤‡ä»½è¯·æ±‚å¼‚å¸¸:', error);
                        })
                        .finally(() => {
                            this.innerHTML = originalText;
                            this.disabled = false;
                        });
                });
            });
        }

        // 3. å•è®¾å¤‡å¥åº·æ£€æŸ¥åŠŸèƒ½
        function initHealthCheckFunction() {
            document.querySelectorAll('.health-check-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const hostname = this.getAttribute('data-hostname');
                    const btn = this;
                    const originalText = btn.innerHTML;

                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>æ£€æŸ¥ä¸­...';
                    btn.disabled = true;

                    // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜
                    document.getElementById('healthCheckDeviceName').textContent = hostname;

                    fetch(`/api/health/${hostname}`)
                        .then(response => response.json().then(data => ({ response, data })))
                        .then(({ response, data }) => {
                            if (!response.ok) throw new Error(`è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
                            const result = data;
                            const container = document.getElementById('healthCheckResultContainer');

                            // ç¡®å®šçŠ¶æ€æ ·å¼
                            let statusClass = 'bg-secondary';
                            let statusText = 'æœªçŸ¥';
                            if (result.status === 'healthy' || result.status === 'åœ¨çº¿') {
                                statusClass = 'bg-success';
                                statusText = 'å¥åº·';
                            } else if (result.status === 'degraded') {
                                statusClass = 'bg-warning';
                                statusText = 'é™çº§';
                            } else if (result.status === 'failed' || result.status === 'ç¦»çº¿') {
                                statusClass = 'bg-danger';
                                statusText = 'å¤±è´¥';
                            }

                            // ç”Ÿæˆç»“æœHTML
                            const resultHtml = `
                                <div class="health-check-card">
                                    <div class="mb-4">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="mb-0">åŸºæœ¬ä¿¡æ¯</h6>
                                            <span class="badge ${statusClass}">${statusText}</span>
                                        </div>
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <p class="mb-1"><strong>è®¾å¤‡åç§°ï¼š</strong>${result.device_name || 'æœªçŸ¥'}</p>
                                                <p class="mb-1"><strong>IPåœ°å€ï¼š</strong>${result.host || 'æœªçŸ¥'}</p>
                                                <p class="mb-1"><strong>ç‰ˆæœ¬ä¿¡æ¯ï¼š</strong>${result.version || 'æœªçŸ¥'}</p>
                                                <p class="mb-1"><strong>æ£€æŸ¥æ—¶é—´ï¼š</strong>${result.check_time || 'æœªçŸ¥'}</p>
                                            </div>
                                            <div class="col-md-6">
                                                <p class="mb-1"><strong>å¥åº·çŠ¶æ€ï¼š</strong>${result.status || 'æœªçŸ¥'}</p>
                                                <p class="mb-1"><strong>æ£€æŸ¥çŠ¶æ€ï¼š</strong>${result.check_status || 'æœªçŸ¥'}</p>
                                                <p class="mb-1"><strong>å¯è¾¾æ€§ï¼š</strong>${result.reachable ? 'æ˜¯' : 'å¦'}</p>
                                                <p class="mb-1"><strong>é”™è¯¯ä¿¡æ¯ï¼š</strong>${result.error_message || 'æ— '}</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h6 class="mb-3">ç«¯å£ä¿¡æ¯</h6>
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <div class="stat-card text-center">
                                                    <div class="stat-value">${result.up_interface || 0}</div>
                                                    <div class="stat-label">UPç«¯å£</div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="stat-card text-center">
                                                    <div class="stat-value">${result.down_interface || 0}</div>
                                                    <div class="stat-label">DOWNç«¯å£</div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="stat-card text-center">
                                                    <div class="stat-value">${result.total_interface || 0}</div>
                                                    <div class="stat-label">æ€»ç«¯å£</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h6 class="mb-3">èµ„æºä½¿ç”¨ç‡</h6>
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <div class="stat-card text-center">
                                                    <div class="stat-value">${result.CPU_usage || 'N/A'}</div>
                                                    <div class="stat-label">CPUä½¿ç”¨ç‡</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="stat-card text-center">
                                                    <div class="stat-value">${result.memory_usage || 'N/A'}</div>
                                                    <div class="stat-label">å†…å­˜ä½¿ç”¨ç‡</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <h6 class="mb-3">å¥åº·é—®é¢˜</h6>
                                        <div class="bg-opacity-10 rounded-lg p-3" style="background-color: rgba(79, 70, 229, 0.1);">
                                            ${result.device_health_issues && result.device_health_issues.length > 0 ? 
                                                `<ul class="mb-0">${result.device_health_issues.map(issue => `<li>${issue}</li>`).join('')}</ul>` : 
                                                '<p class="mb-0 text-muted">æ— å¥åº·é—®é¢˜</p>'}
                                        </div>
                                    </div>
                                </div>
                            `;

                            container.innerHTML = resultHtml;
                            modalInstances.healthCheckResultModal.show();
                        })
                        .catch(error => {
                            console.error('å¥åº·æ£€æŸ¥å¤±è´¥:', error);
                            const container = document.getElementById('healthCheckResultContainer');
                            container.innerHTML = `<div class="text-center text-danger py-4"><small>å¥åº·æ£€æŸ¥å¤±è´¥ï¼š${error.message}</small></div>`;
                            modalInstances.healthCheckResultModal.show();
                        })
                        .finally(() => {
                            setTimeout(() => {
                                btn.innerHTML = originalText;
                                btn.disabled = false;
                            }, 500);
                        });
                });
            });
        }

        // 4. è®¾å¤‡æ¡£æ¡ˆå¡åŠŸèƒ½ï¼ˆåˆ›å»º+æŸ¥çœ‹å•å¡+æŸ¥çœ‹æ‰€æœ‰å¡ï¼‰
        function initDeviceCardFunction() {
            // åˆ›å»ºè®¾å¤‡æ¡£æ¡ˆå¡å…ƒç´ ï¼ˆå…¬å…±æ–¹æ³•ï¼Œæ— é‡å¤ï¼‰
            window.createDeviceCard = function(cardData) {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.setAttribute('data-hostname', cardData.name || 'unknown');

                // ç¡®å®šçŠ¶æ€æ ·å¼
                let statusClass = 'bg-secondary';
                let statusText = 'æœªçŸ¥';
                if (cardData.status === 'online' || cardData.status === 'åœ¨çº¿') {
                    statusClass = 'bg-success';
                    statusText = 'åœ¨çº¿';
                } else if (cardData.status === 'offline' || cardData.status === 'ç¦»çº¿') {
                    statusClass = 'bg-danger';
                    statusText = 'ç¦»çº¿';
                } else if (cardData.status === 'checking' || cardData.status === 'æ£€æŸ¥ä¸­') {
                    statusClass = 'bg-warning';
                    statusText = 'æ£€æŸ¥ä¸­';
                }

                // å¤„ç†ä½¿ç”¨ç‡æ˜¾ç¤ºï¼Œæ— æ•°æ®æ—¶ä¸åŠ ç™¾åˆ†å·
                const cpuUsage = cardData.cpu_usage && cardData.cpu_usage !== 'N/A' ? `${cardData.cpu_usage}%` : (cardData.cpu_usage || 'æœªçŸ¥');
                const memoryUsage = cardData.memory_usage && cardData.memory_usage !== 'N/A' ? `${cardData.memory_usage}%` : (cardData.memory_usage || 'æœªçŸ¥');

                // å¤„ç†å¯è¾¾æ€§æ˜¾ç¤º
                let reachableText = 'æœªçŸ¥';
                if (cardData.reachable === true || cardData.reachable === 'æ˜¯' || cardData.reachable === 'å¯è¾¾') {
                    reachableText = 'æ˜¯';
                } else if (cardData.reachable === false || cardData.reachable === 'å¦' || cardData.reachable === 'ä¸å¯è¾¾') {
                    reachableText = 'å¦';
                } else if (cardData.reachable === 'æœªæ£€æµ‹') {
                    reachableText = 'æœªæ£€æµ‹';
                }

                card.innerHTML = `
                    <h5 class="card-title mb-2">${cardData.name || 'æœªçŸ¥è®¾å¤‡'}</h5>
                    <div class="stat-value mb-3">${cardData.ip_address || 'æœªçŸ¥IP'}</div>
                    <div class="mb-2">
                        ${statusText !== 'æœªçŸ¥' ? `<span class="badge ${statusClass} mb-2">${statusText}</span>` : ''}
                        <span class="small text-muted">å‚å•†ï¼š${cardData.vendor || 'æœªçŸ¥'}</span>
                        <span class="small text-muted ms-2">ç‰ˆæœ¬ï¼š${cardData.version || 'æœªçŸ¥'}</span>
                    </div>
                    <div class="row text-sm">
                        <div class="col-6 mb-1">
                            <span class="text-muted">UPç«¯å£ï¼š</span>
                            <span>${cardData.up_interface || cardData.up_ports || 0}</span>
                        </div>
                        <div class="col-6 mb-1">
                            <span class="text-muted">DOWNç«¯å£ï¼š</span>
                            <span>${cardData.down_interface || cardData.down_ports || 0}</span>
                        </div>
                        <div class="col-6 mb-1">
                            <span class="text-muted">æ€»ç«¯å£ï¼š</span>
                            <span>${cardData.total_interface || cardData.total_ports || 0}</span>
                        </div>
                        <div class="col-6 mb-1">
                            <span class="text-muted">CPUä½¿ç”¨ç‡ï¼š</span>
                            <span>${cpuUsage}</span>
                        </div>
                        <div class="col-6 mb-1">
                            <span class="text-muted">å†…å­˜ä½¿ç”¨ç‡ï¼š</span>
                            <span>${memoryUsage}</span>
                        </div>
                        <div class="col-6 mb-1">
                            <span class="text-muted">æ˜¯å¦å¯è¾¾ï¼š</span>
                            <span>${reachableText}</span>
                        </div>
                    </div>
                    <div class="mt-3 text-xs text-muted">
                        æœ€åæ£€æŸ¥ï¼š${cardData.last_check || cardData.last_check_time || 'æœªæ£€æŸ¥'}
                    </div>
                `;

                return card;
            };

            // æŸ¥çœ‹å•ä¸ªè®¾å¤‡æ¡£æ¡ˆå¡
            document.querySelectorAll('.view-card-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const hostname = this.getAttribute('data-hostname');
                    const btn = this;
                    const originalText = btn.innerHTML;

                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>åŠ è½½ä¸­...';
                    btn.disabled = true;
                    document.getElementById('singleDeviceCardModalLabel').innerHTML = `<i class="fas fa-id-card text-primary me-2"></i>${hostname} æ¡£æ¡ˆå¡`;
                    const container = document.getElementById('singleDeviceCardContainer');
                    container.innerHTML = '<div class="text-center text-muted py-4"><small>åŠ è½½æ¡£æ¡ˆå¡ä¸­...</small></div>';

                    fetch(`/api/device_cards?device=${hostname}`)
                        .then(response => response.json().then(data => ({ response, data })))
                        .then(({ response, data }) => {
                            if (!response.ok) throw new Error(`è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
                            container.innerHTML = '';
                            const cards = Array.isArray(data) ? data : (data ? [data] : []);

                            if (cards.length > 0) {
                                cards.forEach(cardData => {
                                    const cardElement = createDeviceCard(cardData);
                                    cardElement.style.maxWidth = 'none';
                                    cardElement.style.width = '100%';
                                    cardElement.style.minWidth = '100%';
                                    cardElement.style.margin = '0';
                                    cardElement.style.padding = '1.25rem';
                                    cardElement.style.borderRadius = '0';
                                    cardElement.style.border = 'none';
                                    cardElement.style.borderTop = '1px solid var(--border-color)';
                                    container.appendChild(cardElement);
                                });
                            } else {
                                container.innerHTML = `<div class="text-center text-muted py-4"><small>æœªæ‰¾åˆ°è®¾å¤‡ ${hostname} çš„æ¡£æ¡ˆå¡</small></div>`;
                            }
                            modalInstances.singleDeviceCardModal.show();
                        })
                        .catch(error => {
                            console.error('è·å–æ¡£æ¡ˆå¡å¤±è´¥:', error);
                            container.innerHTML = `<div class="text-center text-danger py-4"><small>è·å–æ¡£æ¡ˆå¡å¤±è´¥ï¼š${error.message}</small></div>`;
                            modalInstances.singleDeviceCardModal.show();
                        })
                        .finally(() => {
                            setTimeout(() => {
                                btn.innerHTML = originalText;
                                btn.disabled = false;
                            }, 500);
                        });
                });
            });

            // ä¸€é”®æŸ¥çœ‹æ‰€æœ‰è®¾å¤‡æ¡£æ¡ˆå¡
            document.getElementById('viewAllCardsBtn').addEventListener('click', function() {
                const btn = this;
                const originalText = btn.innerHTML;

                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>åŠ è½½ä¸­...';
                btn.disabled = true;
                const container = document.getElementById('modalDeviceCardsContainer');
                container.innerHTML = '<div class="text-center text-muted py-4"><small>åŠ è½½æ¡£æ¡ˆå¡ä¸­...</small></div>';

                fetch('/api/device_cards')
                    .then(response => response.json().then(data => ({ response, data })))
                    .then(({ response, data }) => {
                        if (!response.ok) throw new Error(`è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
                        container.innerHTML = '';

                        if (data && data.length > 0) {
                            data.forEach(cardData => {
                                container.appendChild(createDeviceCard(cardData));
                            });
                        } else {
                            container.innerHTML = '<div class="text-center text-muted py-4"><small>æš‚æ— æ¡£æ¡ˆå¡æ•°æ®</small></div>';
                        }
                        modalInstances.deviceCardsModal.show();
                    })
                    .catch(error => {
                        console.error('åŠ è½½æ¡£æ¡ˆå¡å¤±è´¥:', error);
                        container.innerHTML = `<div class="text-center text-danger py-4"><small>åŠ è½½å¤±è´¥ï¼š${error.message}</small></div>`;
                        modalInstances.deviceCardsModal.show();
                    })
                    .finally(() => {
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }, 500);
                    });
            });
        }

        // 5. å¤‡ä»½å†å²æŸ¥è¯¢åŠŸèƒ½
        function initBackupHistoryFunction() {
            let currentModalHostname = '';

            // æ‰“å¼€å¤‡ä»½å†å²æ¨¡æ€æ¡†
            document.querySelectorAll('.backup-history-btn').forEach(button => {
                button.addEventListener('click', function() {
                    currentModalHostname = this.getAttribute('data-hostname');
                    document.getElementById('modalDeviceName').textContent = currentModalHostname;
                    document.getElementById('historyLimit').value = 20;
                    document.getElementById('historyCountInfo').textContent = 'æ€»è®°å½•æ•°ï¼š0 æ¡';
                    modalInstances.backupHistoryModal.show();
                    queryBackupHistory();
                });
            });

            // åˆ·æ–°å¤‡ä»½å†å²
            document.getElementById('refreshHistoryBtn').addEventListener('click', queryBackupHistory);

            // æ ¸å¿ƒæŸ¥è¯¢æ–¹æ³•
            function queryBackupHistory() {
                if (!currentModalHostname) return;

                const historyLimit = document.getElementById('historyLimit');
                const tableBody = document.getElementById('backupHistoryTableBody');
                const countInfo = document.getElementById('historyCountInfo');
                const refreshBtn = document.getElementById('refreshHistoryBtn');

                let limit = parseInt(historyLimit.value.trim());
                if (isNaN(limit) || limit < 1 || limit > 100) {
                    alert('è¯·è¾“å…¥1-100ä¹‹é—´çš„æœ‰æ•ˆæ•°å­—ï¼');
                    historyLimit.value = 20;
                    limit = 20;
                }

                const originalBtnText = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>åˆ·æ–°ä¸­...';
                refreshBtn.disabled = true;
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-warning py-4"><div class="spinner-border spinner-border-sm me-2"></div>æ­£åœ¨æŸ¥è¯¢å¤‡ä»½å†å²...</td></tr>';
                countInfo.textContent = 'æ€»è®°å½•æ•°ï¼šæŸ¥è¯¢ä¸­...';

                const apiUrl = `/api/backup/history/${currentModalHostname}?limit=${limit}`;
                fetch(apiUrl)
                    .then(response => response.json().then(data => ({ response, data })))
                    .then(({ response, data }) => {
                        if (!response.ok) throw new Error(data.error_msg || `è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
                        tableBody.innerHTML = '';

                        if (data.status === 'success' && data.history && data.history.length > 0) {
                            data.history.forEach(record => {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                                    <td>${record.id || 'æœªçŸ¥'}</td>
                                    <td>${record.hostname || currentModalHostname}</td>
                                    <td class="text-truncate" style="max-width: 300px;" title="${record.backup_path || 'æœªçŸ¥è·¯å¾„'}">
                                        ${record.backup_path || 'æœªçŸ¥è·¯å¾„'}
                                    </td>
                                    <td>${record.start_time || record.backup_time || 'æœªçŸ¥æ—¶é—´'}</td>
                                    <td>
                                        ${record.status === 'success' || record.status === 'æˆåŠŸ' 
                                            ? '<span class="badge bg-success">æˆåŠŸ</span>' 
                                            : '<span class="badge bg-danger">å¤±è´¥</span>'}
                                    </td>
                                `;
                                tableBody.appendChild(tr);
                            });
                            countInfo.textContent = `æ€»è®°å½•æ•°ï¼š${data.history_record || data.history.length} æ¡ï¼ˆå½“å‰æŸ¥è¯¢${limit}æ¡ï¼‰`;
                        } else {
                            tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">æš‚æ— å¤‡ä»½å†å²è®°å½•</td></tr>';
                            countInfo.textContent = 'æ€»è®°å½•æ•°ï¼š0 æ¡';
                        }
                    })
                    .catch(error => {
                        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-4">âŒ ${error.message}</td></tr>`;
                        countInfo.textContent = 'æ€»è®°å½•æ•°ï¼šæŸ¥è¯¢å¤±è´¥';
                        console.error('å¤‡ä»½å†å²æŸ¥è¯¢å¼‚å¸¸ï¼š', error);
                    })
                    .finally(() => {
                        refreshBtn.innerHTML = originalBtnText;
                        refreshBtn.disabled = false;
                    });
            }
        }

        // 6. AIå¤‡ä»½æŠ¥å‘Šç”ŸæˆåŠŸèƒ½
        function initAiReportFunction() {
            // AIæŠ¥å‘Šæ ¼å¼è½¬æ¢ï¼ˆä¿®å¤æ­£åˆ™æ¼æ´ï¼‰
            function formatReportToHtml(rawText) {
                if (!rawText || rawText.trim() === '') {
                    return '<span class="report-empty">æš‚æ— æœ‰æ•ˆå¤‡ä»½æ•°æ®å¯ä¾›åˆ†æ</span>';
                }

                let html = rawText.trim();
                html = html.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
                html = html.replace(/<strong>(\d+\. .*?)<\/strong>/g, "<h3>$1</h3>");
                html = html.replace(/\n\*   (.*?)(?=\n|$)/g, "\n<li>$1</li>");
                html = html.replace(/(<li>.*?<\/li>)+/gs, "<ul>$&</ul>");
                html = html.replace(/\n(\d+)\.  (.*?)(?=\n|$)/g, "\n<li>$2</li>");
                html = html.replace(/(<li>.*?<\/li>)+/gs, "<ol>$&</ol>");
                html = html.replace(/\*\((æ³¨ï¼š.*?)\)\*/g, "<p class='report-note'>$1</p>");
                html = html.replace(/\n{2,}/g, "<br><br>");
                html = html.replace(/\n/g, " ");

                return `<div class="report-content-wrapper">${html}</div>`;
            }

            // ç”ŸæˆAIæŠ¥å‘ŠæŒ‰é’®
            document.getElementById('generateReportBtn').addEventListener('click', function() {
                const generateBtn = this;
                const daysInput = document.getElementById('reportDays');
                const reportStatus = document.getElementById('report-status');
                const reportContent = document.getElementById('aiReportContent');
                const reportTime = document.getElementById('reportGenerateTime');

                let days = parseInt(daysInput.value.trim());
                if (isNaN(days) || days < 1 || days > 30) {
                    alert('è¯·è¾“å…¥1-30ä¹‹é—´çš„æœ‰æ•ˆå¤©æ•°ï¼');
                    daysInput.value = 7;
                    return;
                }

                const originalBtnText = generateBtn.innerHTML;
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ç”Ÿæˆä¸­...';
                generateBtn.disabled = true;
                reportStatus.innerHTML = '<span class="text-warning"><i class="fas fa-robot me-1"></i>æ­£åœ¨ç”ŸæˆAIè¿ç»´æŠ¥å‘Šï¼Œè¯·ç¨å€™...</span>';
                reportContent.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary me-2"></div>æŠ¥å‘Šç”Ÿæˆä¸­...</div>';
                reportTime.textContent = '';

                const apiUrl = `/api/backup_record/ai/?days=${days}`;
                fetch(apiUrl)
                    .then(response => response.json().then(data => ({ response, data })))
                    .then(({ response, data }) => {
                        if (!response.ok) throw new Error(data.message || data.error_detail || `è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
                        if (data.code === 200 && data.data && data.data !== '') {
                            reportStatus.innerHTML = '<span class="text-success"><i class="fas fa-check-circle me-1"></i>æŠ¥å‘Šç”ŸæˆæˆåŠŸï¼</span>';
                            reportContent.innerHTML = formatReportToHtml(data.data);
                            if (data.report_time) {
                                reportTime.textContent = `æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š${new Date(data.report_time).toLocaleString('zh-CN')}`;
                            }
                        } else {
                            reportStatus.innerHTML = '<span class="text-muted"><i class="fas fa-info-circle me-1"></i>æš‚æ— æœ‰æ•ˆæŠ¥å‘Šæ•°æ®</span>';
                            reportContent.innerHTML = '<span class="report-empty">æš‚æ— æœ‰æ•ˆå¤‡ä»½æ•°æ®å¯ä¾›åˆ†æ</span>';
                        }
                    })
                    .catch(error => {
                        reportStatus.innerHTML = `<span class="text-danger"><i class="fas fa-times-circle me-1"></i>æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼</span>`;
                        reportContent.innerHTML = `<span class="text-danger text-center py-4">${error.message}</span>`;
                        console.error('AIæŠ¥å‘Šç”Ÿæˆå¼‚å¸¸ï¼š', error);
                    })
                    .finally(() => {
                        generateBtn.innerHTML = originalBtnText;
                        generateBtn.disabled = false;
                    });
            });
        }

        // 7. ç³»ç»Ÿå¥åº·æ£€æŸ¥åŠŸèƒ½
        function initSystemHealthFunction() {
            document.getElementById('checkSystemHealthBtn').addEventListener('click', function() {
                const btn = this;
                const summaryDiv = document.getElementById('systemHealthSummary');
                const metricsContent = document.getElementById('systemMetricsContent');
                const serviceContent = document.getElementById('serviceStatusContent');

                const originalBtnText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>æ£€æŸ¥ä¸­...';
                btn.disabled = true;

                summaryDiv.innerHTML = '<div class="d-flex justify-content-between align-items-center"><span class="fw-bold">æ•´ä½“çŠ¶æ€ï¼š<span class="badge bg-warning">æ£€æŸ¥ä¸­...</span></span><span class="small text-muted">æ­£åœ¨è·å–ç³»ç»Ÿå¥åº·æ•°æ®...</span></div>';
                metricsContent.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary me-2"></div>æ­£åœ¨æ”¶é›†ç³»ç»ŸæŒ‡æ ‡...</div>';
                serviceContent.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary me-2"></div>æ­£åœ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€...</div>';

                fetch('/api/system/healthy')
                    .then(response => response.json().then(data => ({ response, data })))
                    .then(({ response, data }) => {
                        if (!response.ok) throw new Error(data.message || `è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
                        const healthyStatus = data.healthy;
                        const timestamp = data.timestamp ? new Date(data.timestamp).toLocaleString('zh-CN') : 'æœªçŸ¥æ—¶é—´';
                        const systemMetrics = data.system_metrics;
                        const serviceStatus = data.service_status;

                        let overallBadgeClass = 'bg-secondary';
                        let overallText = 'æœªçŸ¥';

                        if (healthyStatus === 'healthy') {
                            overallBadgeClass = 'bg-success';
                            overallText = 'å¥åº·';
                        } else if (healthyStatus === 'degraded') {
                            overallBadgeClass = 'bg-warning text-dark';
                            overallText = 'é™çº§';
                        } else if (healthyStatus === 'unhealthy') {
                            overallBadgeClass = 'bg-danger';
                            overallText = 'ä¸å¥åº·';
                        }

                        summaryDiv.innerHTML = `<div class="d-flex justify-content-between align-items-center"><span class="fw-bold">æ•´ä½“çŠ¶æ€ï¼š<span class="badge ${overallBadgeClass}">${overallText}</span></span><span class="small text-muted">æ£€æŸ¥æ—¶é—´ï¼š${timestamp}</span></div>`;

                        // æ¸²æŸ“ç³»ç»ŸæŒ‡æ ‡
                        if (systemMetrics && typeof systemMetrics === 'object') {
                            metricsContent.innerHTML = `
                                <div class="row g-3">
                                    <div class="col-6">
                                        <div class="stat-card">
                                            <div class="stat-value">${systemMetrics.cpu_percent || 'N/A'}%</div>
                                            <div class="stat-label">CPUä½¿ç”¨ç‡</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-card">
                                            <div class="stat-value">${systemMetrics.memory_percent || 'N/A'}%</div>
                                            <div class="stat-label">å†…å­˜ä½¿ç”¨ç‡</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-card">
                                            <div class="stat-value">${systemMetrics.disk_percent || 'N/A'}%</div>
                                            <div class="stat-label">ç£ç›˜ä½¿ç”¨ç‡</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-card">
                                            <div class="stat-value">${systemMetrics.memory_used_gb || 'N/A'} GB</div>
                                            <div class="stat-label">å†…å­˜å·²ç”¨</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-card">
                                            <div class="stat-value">${systemMetrics.disk_used_gb || 'N/A'} GB</div>
                                            <div class="stat-label">ç£ç›˜å·²ç”¨</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-card">
                                            <div class="stat-value">${systemMetrics.memory_total_gb || 'N/A'} GB</div>
                                            <div class="stat-label">å†…å­˜æ€»é‡</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else if (typeof systemMetrics === 'string') {
                            metricsContent.innerHTML = `<div class="alert alert-danger small mb-0">${systemMetrics}</div>`;
                        } else {
                            metricsContent.innerHTML = '<div class="text-center text-muted py-4"><small>æ— æ³•è·å–ç³»ç»ŸæŒ‡æ ‡æ•°æ®</small></div>';
                        }

                        // æ¸²æŸ“æœåŠ¡çŠ¶æ€
                        if (serviceStatus && typeof serviceStatus === 'object') {
                            let serviceHtml = '<div class="service-list">';
                            const serviceNames = {
                                'web_dashboard': 'Webä»ªè¡¨ç›˜',
                                'database': 'æ•°æ®åº“',
                                'nornir_engine': 'Nornirå¼•æ“'
                            };
                            for (const [serviceName, status] of Object.entries(serviceStatus)) {
                                let badgeClass = 'bg-secondary';
                                let statusText = status;

                                if (status === 'healthy' || (typeof status === 'string' && status.includes('healthy'))) {
                                    badgeClass = 'bg-success';
                                    statusText = 'æ­£å¸¸';
                                } else if (typeof status === 'string' && status.includes('unhealthy')) {
                                    badgeClass = 'bg-danger';
                                    statusText = 'å¼‚å¸¸';
                                }

                                const displayName = serviceNames[serviceName] || serviceName;
                                serviceHtml += `
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>${displayName}</span>
                                        <span class="badge ${badgeClass}">${statusText}</span>
                                    </div>
                                `;
                            }
                            serviceHtml += '</div>';
                            serviceContent.innerHTML = serviceHtml;
                        } else {
                            serviceContent.innerHTML = '<div class="text-center text-muted py-4"><small>æ— æ³•è·å–æœåŠ¡çŠ¶æ€æ•°æ®</small></div>';
                        }
                    })
                    .catch(error => {
                        summaryDiv.innerHTML = '<div class="d-flex justify-content-between align-items-center"><span class="fw-bold">æ•´ä½“çŠ¶æ€ï¼š<span class="badge bg-danger">æ£€æŸ¥å¤±è´¥</span></span><span class="small text-muted">è¯·ç¨åé‡è¯•</span></div>';
                        metricsContent.innerHTML = `<div class="alert alert-danger small mb-0">è·å–ç³»ç»ŸæŒ‡æ ‡å¤±è´¥ï¼š${error.message}</div>`;
                        serviceContent.innerHTML = `<div class="alert alert-danger small mb-0">è·å–æœåŠ¡çŠ¶æ€å¤±è´¥ï¼š${error.message}</div>`;
                        console.error('ç³»ç»Ÿå¥åº·æ£€æŸ¥å¼‚å¸¸ï¼š', error);
                    })
                    .finally(() => {
                        btn.innerHTML = originalBtnText;
                        btn.disabled = false;
                    });
            });
        }

        // 8. Norniræ‰¹é‡å¹¶å‘å¥åº·æ£€æŸ¥åŠŸèƒ½ï¼ˆä¿®å¤å‚æ•°æ‹¼æ¥æ¼æ´ï¼‰
        function initNornirBatchCheckFunction() {
            const nornirSelectAll = document.getElementById('nornirSelectAll');
            const nornirTableSelectAll = document.getElementById('nornirTableSelectAll');
            const nornirSelectedCount = document.getElementById('nornirSelectedCount');
            const nornirBatchCheckBtn = document.getElementById('nornirBatchCheckBtn');
            const nornirDeviceCheckboxes = document.querySelectorAll('.nornirDeviceCheckbox');

            // åŒæ­¥å…¨é€‰çŠ¶æ€
            function syncNornirSelectAllStatus() {
                const allChecked = Array.from(nornirDeviceCheckboxes).every(checkbox => checkbox.checked);
                const anyChecked = Array.from(nornirDeviceCheckboxes).some(checkbox => checkbox.checked);
                nornirSelectAll.checked = allChecked;
                nornirTableSelectAll.checked = allChecked;
                nornirBatchCheckBtn.disabled = !anyChecked;

                const selectedCount = Array.from(nornirDeviceCheckboxes).filter(checkbox => checkbox.checked).length;
                nornirSelectedCount.textContent = `å·²é€‰ï¼š${selectedCount} å°`;
            }

            // å…¨é€‰æŒ‰é’®äº‹ä»¶
            nornirSelectAll.addEventListener('change', function() {
                nornirDeviceCheckboxes.forEach(checkbox => checkbox.checked = this.checked);
                syncNornirSelectAllStatus();
            });
            nornirTableSelectAll.addEventListener('change', function() {
                nornirDeviceCheckboxes.forEach(checkbox => checkbox.checked = this.checked);
                syncNornirSelectAllStatus();
            });
            nornirDeviceCheckboxes.forEach(checkbox => checkbox.addEventListener('change', syncNornirSelectAllStatus));

            // æ‰¹é‡æ£€æŸ¥æŒ‰é’®äº‹ä»¶ï¼ˆä¿®å¤URLå‚æ•°æ‹¼æ¥ï¼‰
            nornirBatchCheckBtn.addEventListener('click', function() {
                const selectedDevices = Array.from(nornirDeviceCheckboxes)
                    .filter(checkbox => checkbox.checked)
                    .map(checkbox => checkbox.getAttribute('data-hostname'));

                if (selectedDevices.length === 0) {
                    alert('è¯·å…ˆé€‰æ‹©è®¾å¤‡ï¼');
                    return;
                }

                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>æ£€æŸ¥ä¸­...';
                this.disabled = true;

                // ç”¨URLSearchParamsæ‹¼æ¥å‚æ•°ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦æŠ¥é”™
                const params = new URLSearchParams();
                selectedDevices.forEach(device => params.append('devices', device));
                const apiUrl = `/api/health/nornir-check?${params.toString()}`;

                fetch(apiUrl)
                    .then(response => response.json().then(data => ({ response, data })))
                    .then(({ response, data }) => {
                        if (!response.ok) throw new Error(`è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
                        const tableBody = document.getElementById('nornirCheckResultTableBody');
                        const successCount = document.getElementById('nornirSuccessCount');
                        const failedCount = document.getElementById('nornirFailedCount');
                        const totalCount = document.getElementById('nornirTotalCount');

                        let success = 0;
                        let failed = 0;
                        tableBody.innerHTML = '';

                        // æ¸²æŸ“æˆåŠŸç»“æœ
                        if (data.success && Array.isArray(data.success)) {
                            data.success.forEach(item => {
                                const tr = document.createElement('tr');
                                const result = item.result;
                                const isSuccess = result.check_status === 'æˆåŠŸ';
                                const statusBadge = isSuccess ? '<span class="badge bg-success">æˆåŠŸ</span>' : '<span class="badge bg-danger">å¤±è´¥</span>';
                                isSuccess ? success++ : failed++;

                                const output = `
                                    <div>
                                        <p><strong>è®¾å¤‡åç§°ï¼š</strong>${result.device_name}</p>
                                        <p><strong>IPåœ°å€ï¼š</strong>${result.host}</p>
                                        <p><strong>ç‰ˆæœ¬ï¼š</strong>${result.version}</p>
                                        <p><strong>çŠ¶æ€ï¼š</strong>${result.status}</p>
                                        <p><strong>æ£€æŸ¥çŠ¶æ€ï¼š</strong>${result.check_status}</p>
                                        <p><strong>UPæ¥å£ï¼š</strong>${result.up_interface}</p>
                                        <p><strong>DOWNæ¥å£ï¼š</strong>${result.down_interface}</p>
                                        <p><strong>CPUä½¿ç”¨ç‡ï¼š</strong>${result.CPU_usage}</p>
                                        <p><strong>å†…å­˜ä½¿ç”¨ç‡ï¼š</strong>${result.memory_usage}</p>
                                        <p><strong>æ£€æŸ¥æ—¶é—´ï¼š</strong>${result.check_time}</p>
                                    </div>
                                `;

                                tr.innerHTML = `
                                    <td>${result.device_name}</td>
                                    <td>${statusBadge}</td>
                                    <td>${output}</td>
                                    <td>${result.check_time}</td>
                                `;
                                tableBody.appendChild(tr);
                            });
                        }

                        // æ¸²æŸ“å¤±è´¥ç»“æœ
                        if (data.failed && Array.isArray(data.failed)) {
                            data.failed.forEach(item => {
                                const tr = document.createElement('tr');
                                const statusBadge = '<span class="badge bg-danger">å¤±è´¥</span>';
                                failed++;

                                const output = `<div><p><strong>é”™è¯¯ä¿¡æ¯ï¼š</strong>${item.error}</p></div>`;
                                tr.innerHTML = `
                                    <td>${item.hostname}</td>
                                    <td>${statusBadge}</td>
                                    <td>${output}</td>
                                    <td>${new Date().toLocaleString('zh-CN')}</td>
                                `;
                                tableBody.appendChild(tr);
                            });
                        }

                        // æ— ç»“æœå¤„ç†
                        if ((!data.success || data.success.length === 0) && (!data.failed || data.failed.length === 0)) {
                            tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger py-4">æš‚æ— æ£€æŸ¥ç»“æœæ•°æ®</td></tr>';
                        }

                        // æ›´æ–°æ±‡æ€»ç»Ÿè®¡
                        successCount.innerHTML = `<i class="fas fa-check-circle me-1"></i>æˆåŠŸï¼š${success} å°`;
                        failedCount.innerHTML = `<i class="fas fa-times-circle me-1"></i>å¤±è´¥ï¼š${failed} å°`;
                        totalCount.innerHTML = `<i class="fas fa-server me-1"></i>æ€»è®¡ï¼š${selectedDevices.length} å°`;

                        modalInstances.nornirCheckResultModal.show();
                    })
                    .catch(error => {
                        console.error('Nornirå¹¶å‘æ£€æŸ¥å¼‚å¸¸ï¼š', error);
                        alert(`å¹¶å‘æ£€æŸ¥å¤±è´¥ï¼š${error.message}`);
                    })
                    .finally(() => {
                        this.innerHTML = originalText;
                        this.disabled = false;
                    });
            });

            // åˆå§‹åŒæ­¥çŠ¶æ€
            syncNornirSelectAllStatus();
        }
    </script>
</body>
</html>