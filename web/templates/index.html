<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetDevOps工具箱 - 智能网络运维平台</title>
    <!-- 引入 Bootstrap 样式 -->
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入 Font Awesome 图标 -->
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 现代化深色主题 */
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --secondary-color: #64748b;
            --background-color: #0f172a;
            --card-background: #1e293b;
            --card-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* 平滑滚动 */
        html {
            scroll-behavior: smooth;
        }

        /* 容器样式 */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* 标题区域 */
        .header-section {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
            background: linear-gradient(135deg, var(--primary-color), var(--info-color));
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            animation: fadeInUp 0.8s ease-out;
        }

        .header-section h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #ffffff, #cbd5e1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-section p {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.9);
            margin: 0;
        }

        /* 卡片样式 */
        .card {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary-color);
        }

        .card-header {
            background-color: rgba(79, 70, 229, 0.1);
            border-bottom: 1px solid var(--border-color);
            padding: 1.25rem 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-body {
            padding: 1.5rem;
            background-color: var(--card-background);
        }

        /* 按钮样式 */
        .btn {
            border-radius: 8px;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            text-transform: none;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
        }

        .btn-info {
            background-color: var(--info-color);
            border-color: var(--info-color);
        }

        .btn-info:hover {
            background-color: #2563eb;
            border-color: #2563eb;
        }

        .btn-outline-primary {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background-color: transparent;
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-outline-secondary {
            border-color: var(--secondary-color);
            color: var(--secondary-color);
            background-color: transparent;
        }

        .btn-outline-secondary:hover {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-outline-dark {
            border-color: var(--secondary-color);
            color: var(--secondary-color);
            background-color: transparent;
        }

        .btn-outline-dark:hover {
            background-color: var(--secondary-color);
            color: white;
        }

        /* 表格样式 */
        .table {
            color: var(--text-primary);
            background-color: var(--card-background);
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 12px;
            overflow: hidden;
        }

        .table thead {
            background-color: rgba(79, 70, 229, 0.1);
            color: var(--text-primary);
        }

        .table th,
        .table td {
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.25rem;
        }

        .table tbody tr {
            transition: var(--transition);
        }

        .table tbody tr:hover {
            background-color: rgba(79, 70, 229, 0.2);
            transform: translateX(4px);
        }

        .table-hover tbody tr:hover {
            background-color: rgba(79, 70, 229, 0.2);
        }

        /* 确保表格中所有文字在深色主题上清晰可见 */
        .table {
            color: var(--text-primary) !important;
        }

        .table td {
            color: var(--text-primary) !important;
        }

        .table .badge {
            color: var(--text-primary) !important;
        }

        /* 覆盖默认的text-dark样式 */
        .table .text-dark {
            color: var(--text-primary) !important;
        }

        /* 确保行悬停时所有文字保持白色 */
        .table tbody tr:hover {
            color: var(--text-primary) !important;
        }

        .table tbody tr:hover td {
            color: var(--text-primary) !important;
        }

        /* 徽章样式 */
        .badge {
            border-radius: 9999px;
            font-weight: 600;
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }

        .bg-success {
            background-color: var(--success-color);
        }

        .bg-danger {
            background-color: var(--danger-color);
        }

        .bg-warning {
            background-color: var(--warning-color);
            color: var(--background-color);
        }

        .bg-info {
            background-color: var(--info-color);
        }

        .bg-secondary {
            background-color: var(--secondary-color);
        }

        /* 表单样式 */
        .form-control {
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            transition: var(--transition);
        }

        .form-control:focus {
            background-color: var(--background-color);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            color: var(--text-primary);
        }

        .form-control::placeholder {
            color: var(--text-muted);
        }

        .form-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* 复选框样式 */
        .form-check-input {
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            transition: var(--transition);
        }

        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .form-check-input:focus {
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* 模态框样式 */
        .modal-content {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            background-color: rgba(79, 70, 229, 0.1);
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .modal-title {
            color: var(--text-primary);
        }

        .modal-footer {
            background-color: var(--card-background);
            border-top: 1px solid var(--border-color);
        }

        /* 滚动容器 */
        .modal-table-container {
            max-height: 400px;
            overflow-y: auto;
            background-color: var(--card-background);
            border-radius: 8px;
        }

        .ai-report-container {
            max-height: 300px;
            overflow-y: auto;
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            transition: var(--transition);
        }

        .ai-report-container:hover {
            border-color: var(--primary-color);
        }

        /* AI报告样式 */
        .ai-report-container strong {
            color: var(--primary-color);
            font-weight: 600;
        }

        .ai-report-container h3 {
            font-size: 1rem;
            color: var(--info-color);
            margin: 1.2rem 0 0.8rem 0;
            padding-bottom: 0.3rem;
            border-bottom: 1px solid var(--border-color);
        }

        /* 原始命令输出样式 */
        .raw-command-output {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background-color: var(--background-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            overflow-x: auto;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        /* 页脚样式 */
        footer {
            background-color: rgba(30, 41, 59, 0.5);
            border-top: 1px solid var(--border-color);
            padding: 2rem 0;
            margin-top: 3rem;
            text-align: center;
            border-radius: 12px 12px 0 0;
        }

        /* 系统健康卡片 */
        .health-card {
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            transition: var(--transition);
        }

        .health-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        /* 动画效果 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* 加载动画 */
        .spinner-border {
            border-color: var(--primary-color);
            border-right-color: transparent;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .header-section h1 {
                font-size: 2rem;
            }

            .card {
                margin-bottom: 1.5rem;
            }

            .table th,
            .table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.875rem;
            }
        }

        /* 统计卡片 */
        .stat-card {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-card .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* 服务状态列表 */
        .service-list .list-group-item {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: var(--transition);
        }

        .service-list .list-group-item:hover {
            background-color: var(--card-hover);
            border-color: var(--primary-color);
        }

        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }

        /* 选择设备计数 */
        #nornirSelectedCount {
            background-color: var(--primary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        /* 卡片网格布局 */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* 设备状态指示器 */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .status-dot.online {
            background-color: var(--success-color);
        }

        .status-dot.offline {
            background-color: var(--danger-color);
        }

        .status-dot.pending {
            background-color: var(--warning-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 导航 -->
        <nav class="navbar navbar-expand-lg navbar-dark mb-4" style="background-color: var(--card-background); border: 1px solid var(--border-color); border-radius: 12px;">
            <div class="container-fluid">
                <a class="navbar-brand" href="/" style="color: var(--text-primary); font-weight: 600;">NetDevOps工具箱</a>
                <div class="navbar-nav">
                    <a class="nav-link active" href="/" style="color: var(--text-primary);">设备管理</a>
                    <a class="nav-link" href="/cloud" style="color: var(--text-primary);">☁️ 云网络概念</a>
                </div>
            </div>
        </nav>

        <!-- 页面标题区域 -->
        <div class="header-section">
            <h1><i class="fas fa-toolbox me-3"></i>NetDevOps工具箱仪表盘</h1>
            <p>智能网络设备自动化运维平台</p>
        </div>

        <!-- 顶部卡片网格 -->
        <div class="row mb-4">
            <!-- API服务状态卡片 -->
            <div class="col-md-6 col-lg-4">
                <div class="card h-100">
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h5 class="card-title mb-1"><i class="fas fa-plug text-info me-2"></i>API服务状态</h5>
                                <p id="api-status" class="mb-0 text-muted">检查中...</p>
                            </div>
                            <button id="refresh-api-btn" onclick="checkApiStatus()" class="btn btn-sm btn-info">
                                <i class="fas fa-sync-alt me-1"></i>刷新
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI报告卡片 -->
            <div class="col-md-6 col-lg-8">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-line text-primary me-2"></i>AI备份运维报告</h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center mb-3">
                            <div class="col-md-8">
                                <label for="reportDays" class="form-label">查询近N天备份（1-30天）</label>
                                <input type="number" class="form-control" id="reportDays" value="7" min="1" max="30">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button id="generateReportBtn" class="btn btn-primary w-100">
                                    <i class="fas fa-robot me-1"></i>生成AI报告
                                </button>
                            </div>
                        </div>
                        
                        <p id="report-status" class="mb-2">
                            <span class="text-muted">点击「生成AI报告」获取运维摘要</span>
                        </p>
                        
                        <div class="ai-report-container" id="aiReportContent">
                            <span class="text-muted text-center d-block py-4">暂无报告内容，请先生成</span>
                        </div>
                        
                        <div class="mt-2 small text-muted" id="reportGenerateTime"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 系统健康检查卡片 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-heartbeat text-danger me-2"></i>系统健康状态</h5>
                        <button id="checkSystemHealthBtn" class="btn btn-primary">
                            <i class="fas fa-stethoscope me-1"></i>一键检查系统健康
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- 整体健康结论 -->
                        <div class="health-card mb-4" id="systemHealthSummary">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold">整体状态：<span class="text-muted">未检查</span></span>
                                <span class="small text-muted">点击上方按钮开始检查</span>
                            </div>
                        </div>

                        <!-- 系统指标和服务状态 -->
                        <div class="row">
                            <!-- 系统级别指标 -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header py-2">
                                        <h6 class="mb-0"><i class="fas fa-tachometer-alt text-warning me-2"></i>系统级别指标</h6>
                                    </div>
                                    <div class="card-body" id="systemMetricsContent">
                                        <div class="text-center text-muted py-4">
                                            <small>暂无指标数据，请先执行检查</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 服务健康状态 -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header py-2">
                                        <h6 class="mb-0"><i class="fas fa-server text-success me-2"></i>服务健康状态</h6>
                                    </div>
                                    <div class="card-body" id="serviceStatusContent">
                                        <div class="text-center text-muted py-4">
                                            <small>暂无服务状态，请先执行检查</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 设备列表卡片 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-network-wired text-secondary me-2"></i>设备状态总览</h5>
            </div>
            <div class="card-body">
                <!-- Nornir批量并发检查区域 -->
                <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between mb-4 p-3 bg-opacity-10 rounded-lg" style="background-color: rgba(79, 70, 229, 0.1);">
                    <div class="d-flex align-items-center">
                        <input type="checkbox" id="nornirSelectAll" class="form-check-input me-2">
                        <label for="nornirSelectAll" class="form-label mb-0">全选设备</label>
                        <span id="nornirSelectedCount" class="ms-3">已选：0 台</span>
                    </div>
                    <button id="nornirBatchCheckBtn" class="btn btn-primary" disabled>
                        <i class="fas fa-rocket me-1"></i>Nornir并发健康检查
                    </button>
                </div>

                <!-- 响应式表格 -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <!-- Nornir批量选择列 -->
                                <th>
                                    <input type="checkbox" id="nornirTableSelectAll" class="form-check-input">
                                </th>
                                <th>设备名</th>
                                <th>IP地址</th>
                                <th>设备类型</th>
                                <th>设备状态</th>
                                <th>备份状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for device in devices %}
                            <tr>
                                <!-- Nornir批量选择列 -->
                                <td>
                                    <input type="checkbox" class="form-check-input nornirDeviceCheckbox" data-hostname="{{ device.device_name }}">
                                </td>
                                <td>{{ device.device_name }}</td>
                                <td>{{ device.host }}</td>
                                <td>
                                    <span class="badge bg-info text-dark">{{ device.device_type }}</span>
                                </td>
                                <!-- 设备状态列 -->
                                <td class="device-status">
                                    {% if device.status == '在线' %}
                                    <span class="status-indicator">
                                        <span class="status-dot online"></span>
                                        <span class="badge bg-success">在线</span>
                                    </span>
                                    {% else %}
                                    <span class="status-indicator">
                                        <span class="status-dot offline"></span>
                                        <span class="badge bg-danger">离线</span>
                                    </span>
                                    {% endif %}
                                </td>
                                <!-- 备份状态列 -->
                                <td class="backup-status">
                                    <span class="badge bg-secondary">未备份</span>
                                </td>
                                <!-- 操作列 -->
                                <td>
                                    <div class="d-flex gap-2">
                                        <!-- 健康检查按钮 -->
                                        <button class="btn btn-sm btn-outline-primary health-check-btn" data-hostname="{{ device.device_name }}">
                                            <i class="fas fa-heartbeat me-1"></i>健康检查
                                        </button>
                                        <!-- 备份按钮 -->
                                        <button class="btn btn-sm btn-outline-secondary backup-btn" data-hostname="{{ device.device_name }}">
                                            <i class="fas fa-save me-1"></i>备份设备
                                        </button>
                                        <!-- 查看备份历史按钮 -->
                                        <button class="btn btn-sm btn-outline-dark backup-history-btn" data-hostname="{{ device.device_name }}">
                                            <i class="fas fa-history me-1"></i>备份历史
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 页脚区域 -->
        <footer class="mt-5 py-4">
            <div class="container">
                <div class="text-center">
                    <p class="mb-0">
                        <i class="fas fa-code text-primary me-1"></i>版本 0.5.0 | 基于Flask构建 | 
                        <i class="fas fa-desktop text-info me-1"></i>设备总数: {{ devices|length }} 台
                    </p>
                    <p class="small text-muted mt-1">
                        © 2026 NetDevOps Toolbox | 智能网络运维解决方案
                    </p>
                </div>
            </div>
        </footer>
    </div>

    <!-- 备份历史模态框 -->
    <div class="modal fade" id="backupHistoryModal" tabindex="-1" aria-labelledby="backupHistoryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="backupHistoryModalLabel">
                        <i class="fas fa-history text-primary me-2"></i>设备备份历史 - <span id="modalDeviceName">未知设备</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 备份历史查询条件 -->
                    <div class="row mb-3 align-items-center">
                        <div class="col-md-4">
                            <label for="historyLimit" class="form-label">查询记录数（1-100）</label>
                            <input type="number" class="form-control" id="historyLimit" value="20" min="1" max="100">
                        </div>
                        <div class="col-md-8 d-flex align-items-end justify-content-md-end">
                            <button id="refreshHistoryBtn" class="btn btn-info">
                                <i class="fas fa-sync-alt me-1"></i>刷新备份历史
                            </button>
                        </div>
                    </div>

                    <!-- 备份历史表格 -->
                    <div class="modal-table-container">
                        <table class="table table-hover table-sm">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>记录ID</th>
                                    <th>设备名</th>
                                    <th>备份路径</th>
                                    <th>备份时间</th>
                                    <th>备份状态</th>
                                </tr>
                            </thead>
                            <tbody id="backupHistoryTableBody">
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">请点击「刷新备份历史」获取记录</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 备份历史统计信息 -->
                    <div class="mt-3 small text-muted">
                        <span id="historyCountInfo">总记录数：0 条</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Nornir并发检查结果模态框 -->
    <div class="modal fade" id="nornirCheckResultModal" tabindex="-1" aria-labelledby="nornirCheckResultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nornirCheckResultModalLabel">
                        <i class="fas fa-chart-pie text-primary me-2"></i>Nornir并发健康检查结果
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 并发检查汇总信息 -->
                    <div class="card mb-3" style="background-color: rgba(79, 70, 229, 0.1);">
                        <div class="card-body">
                            <div class="d-flex flex-wrap gap-4 justify-content-between align-items-center">
                                <span class="fw-bold">汇总结果：</span>
                                <div class="d-flex gap-3">
                                    <span id="nornirSuccessCount" class="text-success"><i class="fas fa-check-circle me-1"></i>成功：0 台</span>
                                    <span id="nornirFailedCount" class="text-danger"><i class="fas fa-times-circle me-1"></i>失败：0 台</span>
                                    <span id="nornirTotalCount" class="text-muted"><i class="fas fa-server me-1"></i>总计：0 台</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 并发检查详细结果表格 -->
                    <div class="modal-table-container" style="max-height: 600px;">
                        <table class="table table-hover table-sm">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 120px;">设备名</th>
                                    <th style="width: 100px;">检查状态</th>
                                    <th style="flex: 1;">原始命令输出</th>
                                    <th style="width: 180px;">检查时间</th>
                                </tr>
                            </thead>
                            <tbody id="nornirCheckResultTableBody">
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">暂无检查结果，请先执行并发检查</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
    // 为所有“健康检查”按钮添加点击事件
    document.querySelectorAll('.health-check-btn').forEach(button => {
        button.addEventListener('click', function() {
            const hostname = this.getAttribute('data-hostname');
            const statusCell = this.closest('tr').querySelector('.device-status');
            
            const originalText = this.textContent;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>检查中...';
            this.disabled = true;
            statusCell.innerHTML = '<div class="status-indicator"><span class="status-dot pending"></span><span class="badge bg-warning">检查中</span></div>';
            
            fetch(`/api/health/${hostname}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`请求失败，状态码：${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status && data.status.toLowerCase() === '成功') {
                        statusCell.innerHTML = '<div class="status-indicator"><span class="status-dot online"></span><span class="badge bg-success">在线</span></div>';
                    } else {
                        statusCell.innerHTML = '<div class="status-indicator"><span class="status-dot offline"></span><span class="badge bg-danger">异常</span></div>';
                    }
                })
                .catch(error => {
                    statusCell.innerHTML = '<div class="status-indicator"><span class="status-dot offline"></span><span class="badge bg-danger">失败</span></div>';
                    console.error('健康检查请求失败:', error);
                })
                .finally(() => {
                    this.innerHTML = '<i class="fas fa-heartbeat me-1"></i>健康检查';
                    this.disabled = false;
                });
        });
    });
    </script>

    <!-- 备份功能JS脚本 -->
    <script>
    document.querySelectorAll('.backup-btn').forEach(button => {
        button.addEventListener('click', function() {
            const hostname = this.getAttribute('data-hostname');
            const backupCell = this.closest('tr').querySelector('.backup-status');
            
            const originalText = this.textContent;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>备份中...';
            this.disabled = true;
            backupCell.innerHTML = '<div class="status-indicator"><span class="status-dot pending"></span><span class="badge bg-warning">备份中</span></div>';
            
            fetch(`/api/backup/${hostname}`)
                .then(response => {
                    return response.json().then(data => {
                        if (!response.ok) {
                            throw new Error(data.message || `备份请求失败，状态码：${response.status}`);
                        }
                        return data;
                    });
                })
                .then(data => {
                    if (data.status && data.status === '成功') {
                        const successHtml = `
                            <div class="status-indicator">
                                <span class="status-dot online"></span>
                                <span class="badge bg-success">备份成功</span>
                            </div>
                            <small class="text-muted d-block mt-1">
                                备份路径：${data.backup_path || '未知路径'}
                            </small>
                        `;
                        backupCell.innerHTML = successHtml;
                    } else {
                        backupCell.innerHTML = `<div class="status-indicator"><span class="status-dot offline"></span><span class="badge bg-danger">备份失败：${data.message || '未知错误'}</span></div>`;
                    }
                })
                .catch(error => {
                    backupCell.innerHTML = `<div class="status-indicator"><span class="status-dot offline"></span><span class="badge bg-danger">❌ ${error.message}</span></div>`;
                    console.error('备份请求异常:', error);
                })
                .finally(() => {
                    this.innerHTML = '<i class="fas fa-save me-1"></i>备份设备';
                    this.disabled = false;
                });
        });
    });
    </script>

    <!-- API状态检查JS脚本 -->
    <script>
    function checkApiStatus() {
        const statusElement = document.getElementById('api-status');
        const refreshBtn = document.getElementById('refresh-api-btn');
        
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>刷新中...';
        statusElement.innerHTML = '<div class="status-indicator"><span class="status-dot pending"></span><span class="badge bg-warning">检查中...</span></div>';
        
        fetch('/api/service_status')
            .then(response => {
                return response.json().then(data => {
                    if (!response.ok) {
                        throw new Error(`API请求失败，状态码：${response.status}`);
                    }
                    return data;
                });
            })
            .then(data => {
                if (!data || !data.status) {
                    statusElement.innerHTML = '<div class="status-indicator"><span class="status-dot offline"></span><span class="badge bg-secondary">未知状态</span></div>';
                    return;
                }
                
                if (data.status === 'healthy') {
                    statusElement.innerHTML = '<div class="status-indicator"><span class="status-dot online"></span><span class="badge bg-success">服务正常</span></div>';
                } else {
                    const errorMsg = data.message || '未知异常';
                    statusElement.innerHTML = `<div class="status-indicator"><span class="status-dot offline"></span><span class="badge bg-warning">服务异常: ${errorMsg}</span></div>`;
                }
            })
            .catch(error => {
                statusElement.innerHTML = '<div class="status-indicator"><span class="status-dot offline"></span><span class="badge bg-danger">请求失败</span></div>';
                console.error('API状态检查失败详情：', error);
            })
            .finally(() => {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>刷新';
            });
    }

    document.addEventListener('DOMContentLoaded', checkApiStatus);
    </script>

    <!-- 备份历史查询JS脚本 -->
    <script>
    let currentModalHostname = '';
    const backupHistoryModal = new bootstrap.Modal(document.getElementById('backupHistoryModal'));

    document.querySelectorAll('.backup-history-btn').forEach(button => {
        button.addEventListener('click', function() {
            currentModalHostname = this.getAttribute('data-hostname');
            const modalDeviceName = document.getElementById('modalDeviceName');
            const historyLimit = document.getElementById('historyLimit');
            
            modalDeviceName.textContent = currentModalHostname;
            historyLimit.value = 20;
            document.getElementById('historyCountInfo').textContent = '总记录数：0 条';
            
            backupHistoryModal.show();
            queryBackupHistory();
        });
    });

    document.getElementById('refreshHistoryBtn').addEventListener('click', function() {
        queryBackupHistory();
    });

    function queryBackupHistory() {
        if (!currentModalHostname) return;
        
        const historyLimit = document.getElementById('historyLimit');
        const tableBody = document.getElementById('backupHistoryTableBody');
        const countInfo = document.getElementById('historyCountInfo');
        const refreshBtn = document.getElementById('refreshHistoryBtn');
        
        let limit = parseInt(historyLimit.value.trim());
        if (isNaN(limit) || limit < 1 || limit > 100) {
            alert('请输入1-100之间的有效数字！');
            historyLimit.value = 20;
            limit = 20;
        }
        
        const originalBtnText = refreshBtn.innerHTML;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>刷新中...';
        refreshBtn.disabled = true;
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-warning py-4"><div class="spinner-border spinner-border-sm me-2"></div>正在查询备份历史...</td></tr>';
        countInfo.textContent = '总记录数：查询中...';
        
        const apiUrl = `/api/backup/history/${currentModalHostname}?limit=${limit}`;
        fetch(apiUrl)
            .then(response => {
                return response.json().then(data => {
                    if (!response.ok) {
                        throw new Error(data.error_msg || `请求失败，状态码：${response.status}`);
                    }
                    return data;
                });
            })
            .then(data => {
                tableBody.innerHTML = '';
                
                if (data.status === 'success' && data.history && data.history.length > 0) {
                    data.history.forEach(record => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${record.id || '未知'}</td>
                            <td>${record.hostname || currentModalHostname}</td>
                            <td class="text-truncate" style="max-width: 300px;" title="${record.backup_path || '未知路径'}">
                                ${record.backup_path || '未知路径'}
                            </td>
                            <td>${record.start_time || record.backup_time || '未知时间'}</td>
                            <td>
                                ${record.status === 'success' || record.status === '成功' 
                                    ? '<span class="badge bg-success">成功</span>' 
                                    : '<span class="badge bg-danger">失败</span>'}
                            </td>
                        `;
                        tableBody.appendChild(tr);
                    });
                    
                    countInfo.textContent = `总记录数：${data.history_record || data.history.length} 条（当前查询${limit}条）`;
                } else {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">暂无备份历史记录</td></tr>';
                    countInfo.textContent = '总记录数：0 条';
                }
            })
            .catch(error => {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-4">❌ ${error.message}</td></tr>`;
                countInfo.textContent = '总记录数：查询失败';
                console.error('备份历史查询异常：', error);
            })
            .finally(() => {
                refreshBtn.innerHTML = originalBtnText;
                refreshBtn.disabled = false;
            });
    }
    </script>

    <!-- AI报告功能JS脚本 -->
    <script>
    function formatReportToHtml(rawText) {
        if (!rawText || rawText.trim() === '') {
            return '<span class="report-empty">暂无有效备份数据可供分析</span>';
        }

        let html = rawText.trim();
        html = html.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
        html = html.replace(/<strong>(\d+\. .*?)<\/strong>/g, "<h3>$1</h3>");
        html = html.replace(/\n\*   (.*?)(?=\n|$)/g, "\n<li>$1</li>");
        html = html.replace(/(<li>.*?<\/li>)+/gs, "<ul>$&</ul>");
        html = html.replace(/\n(\d+)\.  (.*?)(?=\n|$)/g, "\n<li>$2</li>");
        html = html.replace(/(<li>.*?<\/li>)+/gs, "<ol>$&</ol>");
        html = html.replace(/\*\((注：.*?)\)\*/g, "<p class='report-note'>$1</p>");
        html = html.replace(/\n{2,}/g, "<br><br>");
        html = html.replace(/\n/g, " ");

        return `<div class="report-content-wrapper">${html}</div>`;
    }

    document.getElementById('generateReportBtn').addEventListener('click', function() {
        const generateBtn = this;
        const daysInput = document.getElementById('reportDays');
        const reportStatus = document.getElementById('report-status');
        const reportContent = document.getElementById('aiReportContent');
        const reportTime = document.getElementById('reportGenerateTime');
        
        let days = parseInt(daysInput.value.trim());
        if (isNaN(days) || days < 1 || days > 30) {
            alert('请输入1-30之间的有效天数！');
            daysInput.value = 7;
            return;
        }

        const originalBtnText = generateBtn.innerHTML;
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>生成中...';
        generateBtn.disabled = true;
        reportStatus.innerHTML = '<span class="text-warning"><i class="fas fa-robot me-1"></i>正在生成AI运维报告，请稍候...</span>';
        reportContent.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary me-2"></div>报告生成中...</div>';
        reportTime.textContent = '';

        const apiUrl = `/api/backup_record/ai/?days=${days}`;
        fetch(apiUrl)
            .then(response => {
                return response.json().then(data => {
                    if (!response.ok) {
                        throw new Error(data.message || data.error_detail || `请求失败，状态码：${response.status}`);
                    }
                    return data;
                });
            })
            .then(data => {
                if (data.code === 200) {
                    if (data.data && data.data !== '') {
                        reportStatus.innerHTML = '<span class="text-success"><i class="fas fa-check-circle me-1"></i>报告生成成功！</span>';
                        const formattedHtml = formatReportToHtml(data.data);
                        reportContent.innerHTML = formattedHtml;
                        if (data.report_time) {
                            const formatTime = new Date(data.report_time).toLocaleString('zh-CN');
                            reportTime.textContent = `报告生成时间：${formatTime}`;
                        }
                    } else {
                        reportStatus.innerHTML = '<span class="text-muted"><i class="fas fa-info-circle me-1"></i>暂无有效报告数据</span>';
                        reportContent.innerHTML = '<span class="report-empty">暂无有效备份数据可供分析</span>';
                    }
                } else {
                    reportStatus.innerHTML = '<span class="text-muted"><i class="fas fa-info-circle me-1"></i>暂无有效报告数据</span>';
                    reportContent.innerHTML = '<span class="report-empty">暂无有效备份数据可供分析</span>';
                }
            })
            .catch(error => {
                reportStatus.innerHTML = `<span class="text-danger"><i class="fas fa-times-circle me-1"></i>报告生成失败！</span>`;
                reportContent.innerHTML = `<span class="text-danger text-center py-4">${error.message}</span>`;
                console.error('AI报告生成异常：', error);
            })
            .finally(() => {
                generateBtn.innerHTML = originalBtnText;
                generateBtn.disabled = false;
            });
    });
    </script>

    <!-- 系统健康检查功能JS脚本 -->
    <script>
    document.getElementById('checkSystemHealthBtn').addEventListener('click', function() {
        const btn = this;
        const summaryDiv = document.getElementById('systemHealthSummary');
        const metricsContent = document.getElementById('systemMetricsContent');
        const serviceContent = document.getElementById('serviceStatusContent');

        const originalBtnText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>检查中...';
        btn.disabled = true;

        summaryDiv.innerHTML = '<div class="d-flex justify-content-between align-items-center"><span class="fw-bold">整体状态：<span class="badge bg-warning">检查中...</span></span><span class="small text-muted">正在获取系统健康数据...</span></div>';
        metricsContent.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary me-2"></div>正在收集系统指标...</div>';
        serviceContent.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary me-2"></div>正在检查服务状态...</div>';

        fetch('/api/system/healthy')
            .then(response => {
                return response.json().then(data => {
                    if (!response.ok) {
                        throw new Error(data.message || `请求失败，状态码：${response.status}`);
                    }
                    return data;
                });
            })
            .then(data => {
                const healthyStatus = data.healthy;
                const timestamp = data.timestamp ? new Date(data.timestamp).toLocaleString('zh-CN') : '未知时间';
                const systemMetrics = data.system_metrics;
                const serviceStatus = data.service_status;

                let overallBadgeClass = 'bg-secondary';
                let overallText = '未知';

                if (healthyStatus === 'healthy') {
                    overallBadgeClass = 'bg-success';
                    overallText = '健康';
                } else if (healthyStatus === 'degraded') {
                    overallBadgeClass = 'bg-warning text-dark';
                    overallText = '降级';
                } else if (healthyStatus === 'unhealthy') {
                    overallBadgeClass = 'bg-danger';
                    overallText = '不健康';
                }

                summaryDiv.innerHTML = `<div class="d-flex justify-content-between align-items-center"><span class="fw-bold">整体状态：<span class="badge ${overallBadgeClass}">${overallText}</span></span><span class="small text-muted">检查时间：${timestamp}</span></div>`;

                if (systemMetrics && typeof systemMetrics === 'object') {
                    metricsContent.innerHTML = `
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="stat-card">
                                    <div class="stat-value">${systemMetrics.cpu_percent || 'N/A'}%</div>
                                    <div class="stat-label">CPU使用率</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card">
                                    <div class="stat-value">${systemMetrics.memory_percent || 'N/A'}%</div>
                                    <div class="stat-label">内存使用率</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card">
                                    <div class="stat-value">${systemMetrics.disk_percent || 'N/A'}%</div>
                                    <div class="stat-label">磁盘使用率</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card">
                                    <div class="stat-value">${systemMetrics.memory_used_gb || 'N/A'} GB</div>
                                    <div class="stat-label">内存已用</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card">
                                    <div class="stat-value">${systemMetrics.disk_used_gb || 'N/A'} GB</div>
                                    <div class="stat-label">磁盘已用</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card">
                                    <div class="stat-value">${systemMetrics.memory_total_gb || 'N/A'} GB</div>
                                    <div class="stat-label">内存总量</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (typeof systemMetrics === 'string') {
                    metricsContent.innerHTML = `<div class="alert alert-danger small mb-0">${systemMetrics}</div>`;
                } else {
                    metricsContent.innerHTML = '<div class="text-center text-muted py-4"><small>无法获取系统指标数据</small></div>';
                }

                if (serviceStatus && typeof serviceStatus === 'object') {
                    let serviceHtml = '<div class="service-list">';
                    for (const [serviceName, status] of Object.entries(serviceStatus)) {
                        let badgeClass = 'bg-secondary';
                        let statusText = status;

                        if (status === 'healthy' || (typeof status === 'string' && status.includes('healthy'))) {
                            badgeClass = 'bg-success';
                            statusText = '正常';
                        } else if (typeof status === 'string' && status.includes('unhealthy')) {
                            badgeClass = 'bg-danger';
                            statusText = '异常';
                        }

                        const serviceNames = {
                            'web_dashboard': 'Web仪表盘',
                            'database': '数据库',
                            'nornir_engine': 'Nornir引擎'
                        };
                        const displayName = serviceNames[serviceName] || serviceName;

                        serviceHtml += `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>${displayName}</span>
                                <span class="badge ${badgeClass}">${statusText}</span>
                            </div>
                        `;
                    }
                    serviceHtml += '</div>';
                    serviceContent.innerHTML = serviceHtml;
                } else {
                    serviceContent.innerHTML = '<div class="text-center text-muted py-4"><small>无法获取服务状态数据</small></div>';
                }
            })
            .catch(error => {
                summaryDiv.innerHTML = '<div class="d-flex justify-content-between align-items-center"><span class="fw-bold">整体状态：<span class="badge bg-danger">检查失败</span></span><span class="small text-muted">请稍后重试</span></div>';
                metricsContent.innerHTML = `<div class="alert alert-danger small mb-0">获取系统指标失败：${error.message}</div>`;
                serviceContent.innerHTML = `<div class="alert alert-danger small mb-0">获取服务状态失败：${error.message}</div>`;
                console.error('系统健康检查异常：', error);
            })
            .finally(() => {
                btn.innerHTML = originalBtnText;
                btn.disabled = false;
            });
    });
    </script>

    <!-- Nornir并发健康检查JS脚本 -->
    <script>
    const nornirSelectAll = document.getElementById('nornirSelectAll');
    const nornirTableSelectAll = document.getElementById('nornirTableSelectAll');
    const nornirSelectedCount = document.getElementById('nornirSelectedCount');
    const nornirBatchCheckBtn = document.getElementById('nornirBatchCheckBtn');
    const nornirDeviceCheckboxes = document.querySelectorAll('.nornirDeviceCheckbox');
    const nornirCheckResultModal = new bootstrap.Modal(document.getElementById('nornirCheckResultModal'));

    function syncNornirSelectAllStatus() {
        const allChecked = Array.from(nornirDeviceCheckboxes).every(checkbox => checkbox.checked);
        const anyChecked = Array.from(nornirDeviceCheckboxes).some(checkbox => checkbox.checked);
        nornirSelectAll.checked = allChecked;
        nornirTableSelectAll.checked = allChecked;
        nornirBatchCheckBtn.disabled = !anyChecked;
        
        const selectedCount = Array.from(nornirDeviceCheckboxes).filter(checkbox => checkbox.checked).length;
        nornirSelectedCount.textContent = `已选：${selectedCount} 台`;
    }

    nornirSelectAll.addEventListener('change', function() {
        nornirDeviceCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        syncNornirSelectAllStatus();
    });

    nornirTableSelectAll.addEventListener('change', function() {
        nornirDeviceCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        syncNornirSelectAllStatus();
    });

    nornirDeviceCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', syncNornirSelectAllStatus);
    });

    nornirBatchCheckBtn.addEventListener('click', function() {
        const selectedDevices = Array.from(nornirDeviceCheckboxes)
            .filter(checkbox => checkbox.checked)
            .map(checkbox => checkbox.getAttribute('data-hostname'));

        if (selectedDevices.length === 0) {
            alert('请先选择设备！');
            return;
        }

        const originalText = this.innerHTML;
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>检查中...';
        this.disabled = true;

        fetch('/api/nornir/check', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ hostnames: selectedDevices }),
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`请求失败，状态码：${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const tableBody = document.getElementById('nornirCheckResultTableBody');
            const successCount = document.getElementById('nornirSuccessCount');
            const failedCount = document.getElementById('nornirFailedCount');
            const totalCount = document.getElementById('nornirTotalCount');

            let success = 0;
            let failed = 0;

            tableBody.innerHTML = '';

            if (data.results && Array.isArray(data.results)) {
                data.results.forEach(result => {
                    const tr = document.createElement('tr');
                    const isSuccess = result.status === 'success' || result.status === '成功';
                    const statusBadge = isSuccess ? '<span class="badge bg-success">成功</span>' : '<span class="badge bg-danger">失败</span>';
                    
                    if (isSuccess) {
                        success++;
                    } else {
                        failed++;
                    }

                    const output = result.output ? `<pre class="raw-command-output mt-1">${result.output}</pre>` : '';

                    tr.innerHTML = `
                        <td>${result.hostname}</td>
                        <td>${statusBadge}</td>
                        <td>${output}</td>
                        <td>${result.timestamp || new Date().toLocaleString('zh-CN')}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            } else {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger py-4">暂无检查结果数据</td></tr>';
            }

            successCount.innerHTML = `<i class="fas fa-check-circle me-1"></i>成功：${success} 台`;
            failedCount.innerHTML = `<i class="fas fa-times-circle me-1"></i>失败：${failed} 台`;
            totalCount.innerHTML = `<i class="fas fa-server me-1"></i>总计：${selectedDevices.length} 台`;

            nornirCheckResultModal.show();
        })
        .catch(error => {
            console.error('Nornir并发检查异常：', error);
            alert(`并发检查失败：${error.message}`);
        })
        .finally(() => {
            this.innerHTML = originalText;
            this.disabled = false;
        });
    });

    syncNornirSelectAllStatus();
    </script>
</body>
</html>