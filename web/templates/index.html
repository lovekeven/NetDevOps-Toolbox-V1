<!DOCTYPE html>
<html>
<head>
    <title>æˆ‘çš„NetDevOpså·¥å…·ç®±</title>
    <!-- å¼•å…¥ Bootstrap æ ·å¼ï¼Œä¿è¯é¡µé¢ç¾è§‚ -->
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* è½»å¾®ä¼˜åŒ–é¡µé¢è§†è§‰ï¼Œé¿å…çº¯ç™½å•è°ƒï¼Œä¸ç ´å Bootstrap åŸæœ‰é£æ ¼ */
        body {
            background-color: #f8f9fa;
        }
        .card-header {
            background-color: #e9f5ff;
        }
        /* æ¨¡æ€æ¡†å†…è¡¨æ ¼æ»šåŠ¨æ ·å¼ï¼ˆé¿å…å†å²è®°å½•è¿‡å¤šæ’‘ç ´é¡µé¢ï¼‰ */
        .modal-table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        /* æ–°å¢ï¼šAIæŠ¥å‘Šå±•ç¤ºåŒºåŸŸæ»šåŠ¨æ ·å¼ */
        .ai-report-container {
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap; /* ä¿ç•™æŠ¥å‘Šä¸­çš„æ¢è¡Œå’Œç©ºæ ¼ï¼Œä¿è¯æ ¼å¼æ•´æ´ */
        }
        /* ========== æ–°å¢ï¼šAIæŠ¥å‘Šæ ¼å¼åŒ–æ ·å¼ï¼ˆè´´åˆBootstrapé£æ ¼ï¼‰ ========== */
        .ai-report-container strong {
            color: #0d6efd; /* Bootstrapä¸»è“è‰²ï¼Œçªå‡ºåŠ ç²—å†…å®¹ */
            font-weight: 600;
        }
        .ai-report-container h3 {
            font-size: 1rem;
            color: #0a58ca;
            margin: 1.2rem 0 0.8rem 0;
            padding-bottom: 0.3rem;
            border-bottom: 1px solid #e9ecef;
        }
        .ai-report-container ul {
            margin: 0.5rem 0 0.5rem 1.5rem;
            padding-left: 0;
            list-style: disc;
        }
        .ai-report-container ol {
            margin: 0.5rem 0 0.5rem 1.5rem;
            padding-left: 0;
            list-style: decimal;
        }
        .ai-report-container li {
            margin: 0.3rem 0;
            color: #212529;
        }
        .ai-report-container .report-note {
            font-size: 0.85rem;
            color: #6c757d;
            font-style: italic;
            margin: 0.5rem 0;
        }
        .ai-report-container .report-empty {
            color: #6c757d;
            text-align: center;
            display: block;
        }
        /* ä¼˜åŒ–ï¼šåŸå§‹å‘½ä»¤è¾“å‡ºæ ·å¼ï¼Œä¿è¯å’Œæ¨¡æ‹Ÿå™¨æ ¼å¼ä¸€è‡´ï¼Œæå‡å¯è¯»æ€§ */
        .raw-command-output {
            font-family: "Consolas", "Monaco", "Courier New", monospace; /* ç­‰å®½å­—ä½“ï¼Œå’Œå‘½ä»¤è¡Œä¸€è‡´ */
            white-space: pre; /* ä¸¥æ ¼ä¿ç•™æ¢è¡Œå’Œç©ºæ ¼ï¼Œä¸è‡ªåŠ¨æ¢è¡Œ */
            word-wrap: normal; /* ç¦æ­¢å•è¯æ¢è¡Œï¼Œä¿æŒåŸå§‹æ ¼å¼ */
            overflow-x: auto; /* æ¨ªå‘æ»šåŠ¨ï¼Œé€‚é…é•¿å‘½ä»¤è¾“å‡º */
            font-size: 12px; /* å¾®è°ƒå­—ä½“å¤§å°ï¼Œå±•ç¤ºæ›´å¤šå†…å®¹ */
            line-height: 1.4; /* ä¼˜åŒ–è¡Œé«˜ï¼Œæå‡å¯è¯»æ€§ */
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- é¡µé¢æ ‡é¢˜åŒºåŸŸ -->
        <h1 class="text-primary">ğŸ› ï¸ NetDevOpså·¥å…·ç®±ä»ªè¡¨ç›˜</h1>
        <p class="text-muted">è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€ä¸ªè‡ªåŠ¨åŒ–è¿ç»´Webç•Œé¢ï¼ï¼ˆå±•ç¤ºæœ€åŸå§‹è®¾å¤‡å‘½ä»¤è¾“å‡ºï¼‰</p>

        <!-- ã€ä»»åŠ¡3æ–°å¢ï¼šAPIæœåŠ¡çŠ¶æ€å¡ç‰‡ã€‘æ”¾åœ¨è®¾å¤‡åˆ—è¡¨å¡ç‰‡ä¸Šæ–¹ï¼Œæ ·å¼ä¸åŸæœ‰é¡µé¢ç»Ÿä¸€ -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ”Œ APIæœåŠ¡çŠ¶æ€</h5>
                        <p id="api-status">æ£€æŸ¥ä¸­...</p>
                        <button id="refresh-api-btn" onclick="checkApiStatus()" class="btn btn-sm btn-info">åˆ·æ–°çŠ¶æ€</button>
                    </div>
                </div>
            </div>
            <!-- ===================================== æ–°å¢å¼€å§‹ï¼šAIæŠ¥å‘Šå°å¡ç‰‡ ===================================== -->
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">ğŸ“Š AIå¤‡ä»½è¿ç»´æŠ¥å‘Š</h5>
                    </div>
                    <div class="card-body">
                        <!-- æŠ¥å‘ŠæŸ¥è¯¢æ¡ä»¶ï¼šå¤©æ•°è¾“å…¥æ¡† -->
                        <div class="row align-items-center mb-3">
                            <div class="col-md-8">
                                <label for="reportDays" class="form-label small text-muted">æŸ¥è¯¢è¿‘Nå¤©å¤‡ä»½ï¼ˆé»˜è®¤7å¤©ï¼Œ1-30å¤©ï¼‰</label>
                                <input type="number" class="form-control form-control-sm" id="reportDays" value="7" min="1" max="30">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button id="generateReportBtn" class="btn btn-sm btn-primary w-100">ç”ŸæˆAIæŠ¥å‘Š</button>
                            </div>
                        </div>
                        
                        <!-- æŠ¥å‘Šç”ŸæˆçŠ¶æ€æç¤º -->
                        <p id="report-status" class="mb-2">
                            <span class="text-muted">ç‚¹å‡»ã€Œç”ŸæˆAIæŠ¥å‘Šã€è·å–è¿ç»´æ‘˜è¦</span>
                        </p>
                        
                        <!-- æŠ¥å‘Šå±•ç¤ºåŒºåŸŸ -->
                        <div class="card bg-light p-3 ai-report-container" id="aiReportContent">
                            <span class="text-muted text-center d-block">æš‚æ— æŠ¥å‘Šå†…å®¹ï¼Œè¯·å…ˆç”Ÿæˆ</span>
                        </div>
                        
                        <!-- æŠ¥å‘Šç”Ÿæˆæ—¶é—´ -->
                        <div class="mt-2 small text-muted" id="reportGenerateTime">
                        </div>
                    </div>
                </div>
            </div>
            <!-- ===================================== æ–°å¢ç»“æŸï¼šAIæŠ¥å‘Šå°å¡ç‰‡ ===================================== -->
        </div>

        <!-- ===================================== æ–°å¢ï¼šç³»ç»Ÿå¥åº·æ£€æŸ¥å¡ç‰‡ ===================================== -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">ğŸ¥ ç³»ç»Ÿå¥åº·çŠ¶æ€</h5>
                        <button id="checkSystemHealthBtn" class="btn btn-sm btn-primary">ä¸€é”®æ£€æŸ¥ç³»ç»Ÿå¥åº·çŠ¶æ€</button>
                    </div>
                    <div class="card-body">
                        <!-- ç¬¬ä¸€å±‚ï¼šæ•´ä½“å¥åº·ç»“è®º -->
                        <div class="card bg-light p-3 mb-3" id="systemHealthSummary">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold">æ•´ä½“çŠ¶æ€ï¼š<span class="text-muted">æœªæ£€æŸ¥</span></span>
                                <span class="small text-muted">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æ£€æŸ¥</span>
                            </div>
                        </div>

                        <!-- ç¬¬äºŒå±‚å’Œç¬¬ä¸‰å±‚ï¼šç³»ç»ŸæŒ‡æ ‡å’ŒæœåŠ¡çŠ¶æ€ï¼ˆåˆ†ä¸¤åˆ—å±•ç¤ºï¼‰ -->
                        <div class="row">
                            <!-- ç¬¬äºŒå±‚ï¼šç³»ç»Ÿçº§åˆ«æŒ‡æ ‡ -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header py-2">
                                        <h6 class="mb-0">ğŸ“Š ç³»ç»Ÿçº§åˆ«æŒ‡æ ‡</h6>
                                    </div>
                                    <div class="card-body" id="systemMetricsContent">
                                        <div class="text-center text-muted py-4">
                                            <small>æš‚æ— æŒ‡æ ‡æ•°æ®ï¼Œè¯·å…ˆæ‰§è¡Œæ£€æŸ¥</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ç¬¬ä¸‰å±‚ï¼šæœåŠ¡å¥åº·çŠ¶æ€ -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header py-2">
                                        <h6 class="mb-0">ğŸ”§ æœåŠ¡å¥åº·çŠ¶æ€</h6>
                                    </div>
                                    <div class="card-body" id="serviceStatusContent">
                                        <div class="text-center text-muted py-4">
                                            <small>æš‚æ— æœåŠ¡çŠ¶æ€ï¼Œè¯·å…ˆæ‰§è¡Œæ£€æŸ¥</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ===================================== æ–°å¢ç»“æŸï¼šç³»ç»Ÿå¥åº·æ£€æŸ¥å¡ç‰‡ ===================================== -->

        <!-- è®¾å¤‡åˆ—è¡¨å¡ç‰‡ -->
        <div class="card mt-4 shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">ğŸ–§ è®¾å¤‡çŠ¶æ€æ€»è§ˆ</h5>
            </div>
            <div class="card-body bg-white">
                <!-- ===================================== æ–°å¢ï¼šNorniræ‰¹é‡å¹¶å‘æ£€æŸ¥åŒºåŸŸ ===================================== -->
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="d-flex align-items-center">
                        <input type="checkbox" id="nornirSelectAll" class="form-check-input me-2">
                        <label for="nornirSelectAll" class="form-label mb-0 text-muted">å…¨é€‰è®¾å¤‡</label>
                        <span id="nornirSelectedCount" class="ms-2 small text-muted">(å·²é€‰ï¼š0 å°)</span>
                    </div>
                    <button id="nornirBatchCheckBtn" class="btn btn-sm btn-primary" disabled>
                        ğŸš€ Nornirå¹¶å‘å¥åº·æ£€æŸ¥
                    </button>
                </div>
                <!-- ===================================== æ–°å¢ç»“æŸï¼šNorniræ‰¹é‡å¹¶å‘æ£€æŸ¥åŒºåŸŸ ===================================== -->

                <!-- å“åº”å¼è¡¨æ ¼ï¼Œæ”¯æŒå°å±å¹•è‡ªé€‚åº” -->
                <table class="table table-hover table-striped align-middle">
                    <thead class="table-light">
                        <tr>
                            <!-- ===================================== æ–°å¢ï¼šNorniræ‰¹é‡é€‰æ‹©åˆ— - è¡¨å¤´ ===================================== -->
                            <th>
                                <input type="checkbox" id="nornirTableSelectAll" class="form-check-input">
                            </th>
                            <!-- ===================================== æ–°å¢ç»“æŸï¼šNorniræ‰¹é‡é€‰æ‹©åˆ— - è¡¨å¤´ ===================================== -->
                            <th>è®¾å¤‡å</th>
                            <th>IPåœ°å€</th>
                            <th>è®¾å¤‡ç±»å‹</th>
                            <th>è®¾å¤‡çŠ¶æ€</th>
                            <!-- ã€æ–°å¢1ï¼šå¤‡ä»½çŠ¶æ€åˆ—ã€‘ä¸“é—¨å±•ç¤ºå¤‡ä»½ç»“æœï¼Œä¸ç ´ååŸæœ‰è®¾å¤‡çŠ¶æ€ -->
                            <th>å¤‡ä»½çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- å¾ªç¯éå† Python è„šæœ¬ä¼ é€’çš„ devices åˆ—è¡¨ï¼Œæ— éœ€ä¿®æ”¹ -->
                        {% for device in devices %}
                        <tr>
                            <!-- ===================================== æ–°å¢ï¼šNorniræ‰¹é‡é€‰æ‹©åˆ— - è¡¨ä½“ ===================================== -->
                            <td>
                                <input type="checkbox" class="form-check-input nornirDeviceCheckbox" data-hostname="{{ device.device_name }}">
                            </td>
                            <!-- ===================================== æ–°å¢ç»“æŸï¼šNorniræ‰¹é‡é€‰æ‹©åˆ— - è¡¨ä½“ ===================================== -->
                            <!-- å¯¹åº” Python è„šæœ¬ä¸­çš„ device_name å­—æ®µï¼ˆSW1/SW2 ç­‰ï¼‰ -->
                            <td>{{ device.device_name }}</td>
                            <!-- å¯¹åº” Python è„šæœ¬ä¸­çš„ host å­—æ®µï¼ˆè®¾å¤‡ IP åœ°å€ï¼‰ -->
                            <td>{{ device.host }}</td>
                            <!-- å¯¹åº” Python è„šæœ¬ä¸­çš„ device_type å­—æ®µï¼ˆhp_comwareï¼‰ï¼ŒåŠ è½»å¾®ç¾åŒ– -->
                            <td>
                                <span class="badge bg-info text-dark">{{ device.device_type }}</span>
                            </td>
                            <!-- ã€ä¿ç•™ã€‘è®¾å¤‡çŠ¶æ€åˆ—ï¼Œå¸¦ device-status ç±»å -->
                            <td class="device-status">
                                {% if device.status == 'åœ¨çº¿' %}
                                <span class="badge bg-success">åœ¨çº¿</span>
                                {% else %}
                                <span class="badge bg-danger">ç¦»çº¿</span>
                                {% endif %}
                            </td>
                            <!-- ã€æ–°å¢2ï¼šå¤‡ä»½çŠ¶æ€å•å…ƒæ ¼ã€‘å¸¦ backup-status ç±»åï¼Œä¾›JSæ›´æ–°å¤‡ä»½ç»“æœ -->
                            <td class="backup-status">
                                <span class="badge bg-secondary">æœªå¤‡ä»½</span>
                            </td>
                            <!-- ã€ä¿®æ”¹ï¼šæ“ä½œåˆ—æ–°å¢ã€ŒæŸ¥çœ‹å¤‡ä»½å†å²ã€æŒ‰é’®ã€‘ä¸åŸæœ‰æŒ‰é’®é£æ ¼ç»Ÿä¸€ -->
                            <td>
                                <!-- å¥åº·æ£€æŸ¥æŒ‰é’®ï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼‰ -->
                                <button class="btn btn-sm btn-outline-primary health-check-btn" data-hostname="{{ device.device_name }}">
                                    å¥åº·æ£€æŸ¥
                                </button>
                                <!-- å¤‡ä»½æŒ‰é’®ï¼ˆæ–°å¢ï¼Œæ ·å¼åè°ƒï¼Œå¸¦ä¸“å±ç±»åå’Œæ•°æ®å±æ€§ï¼‰ -->
                                <button class="btn btn-sm btn-outline-secondary backup-btn ms-1" data-hostname="{{ device.device_name }}">
                                    å¤‡ä»½è®¾å¤‡
                                </button>
                                <!-- ã€æ–°å¢æ ¸å¿ƒï¼šæŸ¥çœ‹å¤‡ä»½å†å²æŒ‰é’®ã€‘æ ·å¼åè°ƒï¼Œå¸¦ä¸“å±ç±»åï¼Œä¼ é€’è®¾å¤‡å -->
                                <button class="btn btn-sm btn-outline-dark backup-history-btn ms-1" data-hostname="{{ device.device_name }}">
                                    å¤‡ä»½å†å²
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- é¡µè„šåŒºåŸŸï¼Œæ˜¾ç¤ºè®¾å¤‡æ€»æ•° -->
        <footer class="mt-4 text-center text-muted">
            <small>ç‰ˆæœ¬ 0.5.0 | åŸºäºFlaskæ„å»º | è®¾å¤‡æ€»æ•°: {{ devices|length }} å°</small>
        </footer>
    </div>

    <!-- ã€æ–°å¢æ ¸å¿ƒï¼šå¤‡ä»½å†å²æ¨¡æ€æ¡†ã€‘ç”¨äºå±•ç¤ºå¤‡ä»½è®°å½•ï¼Œæ ·å¼ä¸é¡µé¢ç»Ÿä¸€ -->
    <div class="modal fade" id="backupHistoryModal" tabindex="-1" aria-labelledby="backupHistoryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content shadow-sm">
                <div class="modal-header" style="background-color: #e9f5ff;">
                    <h5 class="modal-title" id="backupHistoryModalLabel">ğŸ“œ è®¾å¤‡å¤‡ä»½å†å² - <span id="modalDeviceName">æœªçŸ¥è®¾å¤‡</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- å¤‡ä»½å†å²æŸ¥è¯¢æ¡ä»¶ï¼ˆæ”¯æŒlimitå‚æ•°ï¼Œä¸åç«¯APIå¯¹åº”ï¼‰ -->
                    <div class="row mb-3 align-items-center">
                        <div class="col-md-4">
                            <label for="historyLimit" class="form-label small text-muted">æŸ¥è¯¢è®°å½•æ•°ï¼ˆé»˜è®¤20æ¡ï¼‰</label>
                            <input type="number" class="form-control form-control-sm" id="historyLimit" value="20" min="1" max="100">
                        </div>
                        <div class="col-md-8 d-flex align-items-end justify-content-md-end">
                            <button id="refreshHistoryBtn" class="btn btn-sm btn-info">åˆ·æ–°å¤‡ä»½å†å²</button>
                        </div>
                    </div>

                    <!-- å¤‡ä»½å†å²è¡¨æ ¼ï¼ˆå¸¦æ»šåŠ¨å®¹å™¨ï¼Œé¿å…è®°å½•è¿‡å¤šæ’‘ç ´é¡µé¢ï¼‰ -->
                    <div class="modal-table-container">
                        <table class="table table-hover table-striped align-middle table-sm">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>è®°å½•ID</th>
                                    <th>è®¾å¤‡å</th>
                                    <th>å¤‡ä»½è·¯å¾„</th>
                                    <th>å¤‡ä»½æ—¶é—´</th>
                                    <th>å¤‡ä»½çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody id="backupHistoryTableBody">
                                <!-- å¤‡ä»½å†å²æ•°æ®å°†é€šè¿‡JSåŠ¨æ€æ¸²æŸ“ -->
                                <tr>
                                    <td colspan="5" class="text-center text-muted">è¯·ç‚¹å‡»ã€Œåˆ·æ–°å¤‡ä»½å†å²ã€è·å–è®°å½•</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- å¤‡ä»½å†å²ç»Ÿè®¡ä¿¡æ¯ -->
                    <div class="mt-2 small text-muted">
                        <span id="historyCountInfo">æ€»è®°å½•æ•°ï¼š0 æ¡</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===================================== æ–°å¢ï¼šNornirå¹¶å‘æ£€æŸ¥ç»“æœæ¨¡æ€æ¡† ===================================== -->
    <div class="modal fade" id="nornirCheckResultModal" tabindex="-1" aria-labelledby="nornirCheckResultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl"> <!-- æ”¹ä¸ºè¶…å¤§æ¨¡æ€æ¡†ï¼Œæ›´å¥½å±•ç¤ºåŸå§‹å‘½ä»¤è¾“å‡º -->
            <div class="modal-content shadow-sm">
                <div class="modal-header" style="background-color: #e9f5ff;">
                    <h5 class="modal-title" id="nornirCheckResultModalLabel">ğŸ“Š Nornirå¹¶å‘å¥åº·æ£€æŸ¥ç»“æœï¼ˆåŸå§‹å‘½ä»¤è¾“å‡ºï¼‰</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- å¹¶å‘æ£€æŸ¥æ±‡æ€»ä¿¡æ¯ -->
                    <div class="card bg-light p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold">æ±‡æ€»ç»“æœï¼š</span>
                            <span id="nornirSummaryText">å¾…æ£€æŸ¥...</span>
                        </div>
                        <div class="d-flex gap-3 mt-2">
                            <span id="nornirSuccessCount" class="text-success">æˆåŠŸï¼š0 å°</span>
                            <span id="nornirFailedCount" class="text-danger">å¤±è´¥ï¼š0 å°</span>
                            <span id="nornirTotalCount" class="text-muted">æ€»è®¡ï¼š0 å°</span>
                        </div>
                    </div>

                    <!-- å¹¶å‘æ£€æŸ¥è¯¦ç»†ç»“æœè¡¨æ ¼ -->
                    <div class="modal-table-container" style="max-height: 600px;"> <!-- æé«˜æœ€å¤§é«˜åº¦ï¼Œå±•ç¤ºæ›´å¤šå®Œæ•´è¾“å‡º -->
                        <table class="table table-hover table-striped align-middle table-sm">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 120px;">è®¾å¤‡å</th>
                                    <th style="width: 100px;">æ£€æŸ¥çŠ¶æ€</th>
                                    <th style="flex: 1;">åŸå§‹å‘½ä»¤è¾“å‡º</th>
                                    <th style="width: 180px;">æ£€æŸ¥æ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody id="nornirCheckResultTableBody">
                                <tr>
                                    <td colspan="4" class="text-center text-muted">æš‚æ— æ£€æŸ¥ç»“æœï¼Œè¯·å…ˆæ‰§è¡Œå¹¶å‘æ£€æŸ¥</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

   <!-- ã€ä¿ç•™ã€‘å¥åº·æ£€æŸ¥åŠŸèƒ½JSè„šæœ¬ï¼ˆæ— éœ€ä¿®æ”¹ï¼Œä¸åç«¯è¿”å›`ok`çŠ¶æ€åŒ¹é…ï¼‰ -->
<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
<script>
// ä¸ºæ‰€æœ‰â€œå¥åº·æ£€æŸ¥â€æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
document.querySelectorAll('.health-check-btn').forEach(button => {
    button.addEventListener('click', function() {
        // 1. è·å–æŒ‰é’®ç»‘å®šçš„è®¾å¤‡åå’Œå½“å‰è¡Œçš„çŠ¶æ€å•å…ƒæ ¼
        const hostname = this.getAttribute('data-hostname');
        const statusCell = this.closest('tr').querySelector('.device-status');
        
        // 2. ç‚¹å‡»åç«‹å³æ›´æ–°æŒ‰é’®å’ŒçŠ¶æ€ï¼Œç»™å‡ºåŠ è½½åé¦ˆï¼ˆé˜²æ­¢é‡å¤ç‚¹å‡»ï¼‰
        const originalText = this.textContent;
        this.textContent = 'æ£€æŸ¥ä¸­...';
        this.disabled = true;
        statusCell.innerHTML = '<span class="badge bg-warning">æ£€æŸ¥ä¸­</span>';
        
        // 3. è°ƒç”¨åç«¯å¥åº·æ£€æŸ¥API
        fetch(`/api/health/${hostname}`)
            // å¤„ç†é200çŠ¶æ€ç 
            .then(response => {
                if (!response.ok) {
                    throw new Error(`è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // ä¸åç«¯çº¦å®šï¼šå¥åº·æ£€æŸ¥æˆåŠŸè¿”å› status: "ok"ï¼ˆæ— éœ€ä¿®æ”¹ï¼ŒåŒ¹é…åç«¯ï¼‰
                if (data.status && data.status.toLowerCase() === 'æˆåŠŸ') {
                    // æ”¹è‰¯ç‚¹1ï¼šå…ˆæ˜¾ç¤ºã€Œæ£€æŸ¥æˆåŠŸã€åé¦ˆï¼ˆçŸ­æš‚æç¤ºç”¨æˆ·ï¼‰ï¼Œå†æ¢å¤ã€Œåœ¨çº¿ã€é•¿æœŸçŠ¶æ€
                    // æ­¥éª¤1ï¼šç«‹å³æ¸²æŸ“ã€Œæœ¬æ¬¡æ£€æŸ¥æˆåŠŸã€
                    statusCell.innerHTML = '<span class="badge bg-info">æ£€æŸ¥æˆåŠŸ</span>';
                    // æ­¥éª¤2ï¼š3ç§’åè‡ªåŠ¨æ¢å¤ã€Œåœ¨çº¿ã€çŠ¶æ€ï¼ˆå…¼é¡¾ç”¨æˆ·åé¦ˆå’Œé•¿æœŸçŠ¶æ€å±•ç¤ºï¼Œå¯è°ƒæ•´å»¶æ—¶ï¼‰
                    setTimeout(() => {
                        statusCell.innerHTML = '<span class="badge bg-success">åœ¨çº¿</span>';
                    }, 3000);
                } else {
                    // æ”¹è‰¯ç‚¹2ï¼šéæˆåŠŸçŠ¶æ€ç›´æ¥æ¸²æŸ“ã€Œå¼‚å¸¸ã€ï¼Œæ— å»¶æ—¶ï¼ˆæ˜ç¡®è®¾å¤‡æ•…éšœï¼‰
                    statusCell.innerHTML = '<span class="badge bg-danger">å¼‚å¸¸</span>';
                }
                console.log('å¥åº·æ£€æŸ¥è¯¦ç»†ç»“æœ:', data);
            })
            // æ•è·å¼‚å¸¸
            .catch(error => {
                statusCell.innerHTML = '<span class="badge bg-secondary">å¤±è´¥</span>';
                console.error('å¥åº·æ£€æŸ¥è¯·æ±‚å¤±è´¥:', error);
            })
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            .finally(() => {
                this.textContent = originalText;
                this.disabled = false;
            });
    });
});
</script>

    <!-- ã€ä¿®æ”¹æ ¸å¿ƒã€‘å¤‡ä»½åŠŸèƒ½JSè„šæœ¬ï¼ˆå¯¹é½åç«¯è¿”å›çš„ä¸­æ–‡çŠ¶æ€+è¯¦ç»†å­—æ®µï¼‰ -->
    <script>
    // ä¸ºæ‰€æœ‰â€œå¤‡ä»½è®¾å¤‡â€æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.backup-btn').forEach(button => {
        button.addEventListener('click', function() {
            // 1. è·å–æŒ‰é’®ç»‘å®šçš„è®¾å¤‡åå’Œå½“å‰è¡Œçš„å¤‡ä»½çŠ¶æ€å•å…ƒæ ¼
            const hostname = this.getAttribute('data-hostname');
            const backupCell = this.closest('tr').querySelector('.backup-status');
            
            // 2. ç‚¹å‡»åç«‹å³æ›´æ–°æŒ‰é’®å’Œå¤‡ä»½çŠ¶æ€ï¼Œç»™å‡ºåŠ è½½åé¦ˆ
            const originalText = this.textContent;
            this.textContent = 'å¤‡ä»½ä¸­...';
            this.disabled = true;
            backupCell.innerHTML = '<span class="badge bg-warning">å¤‡ä»½ä¸­</span>';
            
            // 3. è°ƒç”¨åç«¯å¤‡ä»½APIï¼ˆå¯¹åº”åç«¯ /api/backup/<hostname>ï¼‰
            fetch(`/api/backup/${hostname}`)
                // ã€ä¿®æ”¹1ï¼šå…ˆè§£æJSONï¼Œå†åˆ¤æ–­å“åº”æ˜¯å¦æ­£å¸¸ï¼Œæ‹¿åˆ°åç«¯è¯¦ç»†ä¿¡æ¯ã€‘
                .then(response => {
                    // æ— è®ºå“åº”æ˜¯å¦okï¼Œå…ˆè§£æåç«¯è¿”å›çš„JSONæ•°æ®ï¼ˆåŒ¹é…åç«¯è¿”å›çš„è¯¦ç»†å­—æ®µï¼‰
                    return response.json().then(data => {
                        if (!response.ok) {
                            // æŠŠåç«¯è¿”å›çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯å¸¦å…¥å¼‚å¸¸
                            throw new Error(data.message || `å¤‡ä»½è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
                        }
                        return data;
                    });
                })
                // å¤„ç†è§£æåçš„å¤‡ä»½ç»“æœï¼Œæ›´æ–°é¡µé¢çŠ¶æ€
                .then(data => {
                    // ã€ä¿®æ”¹2ï¼šåˆ¤æ–­åç«¯è¿”å›çš„ä¸­æ–‡çŠ¶æ€â€œæˆåŠŸâ€ï¼ˆæ›¿æ¢åŸè‹±æ–‡successåˆ¤æ–­ï¼‰ã€‘
                    if (data.status && data.status === 'æˆåŠŸ') {
                        // ã€ä¿®æ”¹3ï¼šå±•ç¤ºåç«¯è¿”å›çš„å¤‡ä»½è·¯å¾„ï¼Œæ›´ç›´è§‚ã€‘
                        const successHtml = `
                            <span class="badge bg-success">å¤‡ä»½æˆåŠŸ</span>
                            <small class="text-muted d-block mt-1">
                                å¤‡ä»½è·¯å¾„ï¼š${data.backup_path || 'æœªçŸ¥è·¯å¾„'}
                            </small>
                        `;
                        backupCell.innerHTML = successHtml;
                    } else {
                        // å±•ç¤ºåç«¯è¿”å›çš„å¤±è´¥æ¶ˆæ¯
                        backupCell.innerHTML = `<span class="badge bg-danger">å¤‡ä»½å¤±è´¥ï¼š${data.message || 'æœªçŸ¥é”™è¯¯'}</span>`;
                    }
                    // æ§åˆ¶å°æ‰“å°è¯¦ç»†å¤‡ä»½ç»“æœï¼ˆå¼€å‘è€…è°ƒè¯•ç”¨ï¼ŒæŸ¥çœ‹åç«¯è¿”å›çš„æ‰€æœ‰å­—æ®µï¼‰
                    console.log('å¤‡ä»½è¯¦ç»†ç»“æœ:', data);
                })
                // æ•è·å¤‡ä»½è¯·æ±‚å¼‚å¸¸ï¼ˆæœåŠ¡å™¨å®•æœºã€APIä¸å­˜åœ¨ã€åç«¯è¿”å›çš„é”™è¯¯ç­‰ï¼‰
                .catch(error => {
                    // å±•ç¤ºè¯¦ç»†å¼‚å¸¸ä¿¡æ¯ï¼ˆæ¥è‡ªåç«¯æˆ–è¯·æ±‚é”™è¯¯ï¼‰
                    backupCell.innerHTML = `<span class="badge bg-secondary">âŒ ${error.message}</span>`;
                    console.error('å¤‡ä»½è¯·æ±‚å¼‚å¸¸:', error);
                })
                // æ— è®ºæˆåŠŸ/å¤±è´¥ï¼Œæœ€ç»ˆæ¢å¤å¤‡ä»½æŒ‰é’®åŸå§‹çŠ¶æ€
                .finally(() => {
                    this.textContent = originalText;
                    this.disabled = false;
                });
        });
    });
    </script>

    <!-- ã€å¾®è°ƒã€‘APIçŠ¶æ€æ£€æŸ¥JSè„šæœ¬ï¼ˆå…¼å®¹åç«¯è¿”å›çš„ä¸­æ–‡å¼‚å¸¸çŠ¶æ€ï¼‰ -->
    <script>
    // æ£€æŸ¥APIçŠ¶æ€çš„å‡½æ•°
    function checkApiStatus() {
        const statusElement = document.getElementById('api-status');
        const refreshBtn = document.getElementById('refresh-api-btn'); // è·å–åˆ·æ–°æŒ‰é’®
        
        // 1. ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»ï¼Œæ›´æ–°æŒ‰é’®æ–‡å­—
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = 'åˆ·æ–°ä¸­...';
        statusElement.innerHTML = '<span class="text-warning">æ£€æŸ¥ä¸­...</span>';
        
        fetch('/api/service_status')
            .then(response => {
                // å…ˆè§£æJSONï¼Œå†åˆ¤æ–­å“åº”æ˜¯å¦æˆåŠŸ
                return response.json().then(data => {
                    if (!response.ok) {
                        throw new Error(`APIè¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
                    }
                    return data;
                });
            })
            .then(data => {
                // 2. å¢åŠ æ•°æ®æ ¼å¼æ ¡éªŒï¼Œé˜²æ­¢åç«¯è¿”å›å¼‚å¸¸æ•°æ®ï¼ˆæå‡å¥å£®æ€§ï¼‰
                if (!data || !data.status) {
                    statusElement.innerHTML = '<span class="badge bg-secondary">â“ æœªçŸ¥çŠ¶æ€ï¼ˆæ•°æ®æ ¼å¼å¼‚å¸¸ï¼‰</span>';
                    return;
                }
                
                // åŒ¹é…åç«¯è¿”å›çš„æ­£å¸¸çŠ¶æ€'healthy'
                if (data.status === 'healthy') {
                    statusElement.innerHTML = '<span class="badge bg-success">âœ… æœåŠ¡æ­£å¸¸</span>';
                } else {
                    // ã€å¾®è°ƒï¼šå…¼å®¹åç«¯è¿”å›çš„ä¸­æ–‡å¼‚å¸¸çŠ¶æ€ï¼Œå±•ç¤ºè¯¦ç»†æ¶ˆæ¯ã€‘
                    const errorMsg = data.message || 'æœªçŸ¥å¼‚å¸¸';
                    statusElement.innerHTML = `<span class="badge bg-warning">âš ï¸ æœåŠ¡å¼‚å¸¸: ${errorMsg}</span>`;
                }
            })
            .catch(error => {
                statusElement.innerHTML = '<span class="badge bg-danger">âŒ è¯·æ±‚å¤±è´¥ï¼ˆæ— æ³•è¿æ¥APIï¼‰</span>';
                // 3. æ‰“å°é”™è¯¯ä¿¡æ¯ï¼Œæ–¹ä¾¿å¼€å‘è€…è°ƒè¯•ï¼ˆç”¨æˆ·ä¸å¯è§ï¼Œä¸å½±å“ä½“éªŒï¼‰
                console.error('APIçŠ¶æ€æ£€æŸ¥å¤±è´¥è¯¦æƒ…ï¼š', error);
            })
            .finally(() => {
                // 4. æ— è®ºæˆåŠŸå¤±è´¥ï¼Œæœ€ç»ˆå¯ç”¨æŒ‰é’®ï¼Œæ¢å¤æŒ‰é’®æ–‡å­—ï¼ˆå’Œå…¶ä»–åŠŸèƒ½é€»è¾‘ä¸€è‡´ï¼‰
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = 'åˆ·æ–°çŠ¶æ€';
            });
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡APIçŠ¶æ€ï¼ˆæ— éœ€æ‰‹åŠ¨ç‚¹å‡»ï¼Œæå‡ä¾¿æ·æ€§ï¼‰
    document.addEventListener('DOMContentLoaded', checkApiStatus);
    </script>

    <!-- ã€æ–°å¢æ ¸å¿ƒï¼šå¤‡ä»½å†å²æŸ¥è¯¢JSè„šæœ¬ã€‘å…¼å®¹åç«¯ç¬¬å››ä¸ªAPIï¼Œè½åœ°ç‰ˆåŠŸèƒ½ -->
    <script>
    // å…¨å±€å˜é‡ï¼šå­˜å‚¨å½“å‰æ¨¡æ€æ¡†å¯¹åº”çš„è®¾å¤‡å
    let currentModalHostname = '';
    // åˆå§‹åŒ–Bootstrapæ¨¡æ€æ¡†
    const backupHistoryModal = new bootstrap.Modal(document.getElementById('backupHistoryModal'));

    // 1. ä¸ºæ‰€æœ‰ã€ŒæŸ¥çœ‹å¤‡ä»½å†å²ã€æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.backup-history-btn').forEach(button => {
        button.addEventListener('click', function() {
            // è·å–è®¾å¤‡å
            currentModalHostname = this.getAttribute('data-hostname');
            const modalDeviceName = document.getElementById('modalDeviceName');
            const historyLimit = document.getElementById('historyLimit');
            
            // åˆå§‹åŒ–æ¨¡æ€æ¡†å†…å®¹
            modalDeviceName.textContent = currentModalHostname;
            historyLimit.value = 20; // é‡ç½®é»˜è®¤è®°å½•æ•°ä¸º20
            document.getElementById('historyCountInfo').textContent = 'æ€»è®°å½•æ•°ï¼š0 æ¡';
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†å¹¶è‡ªåŠ¨æŸ¥è¯¢å¤‡ä»½å†å²
            backupHistoryModal.show();
            queryBackupHistory();
        });
    });

    // 2. ä¸ºã€Œåˆ·æ–°å¤‡ä»½å†å²ã€æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
    document.getElementById('refreshHistoryBtn').addEventListener('click', function() {
        queryBackupHistory();
    });

    // 3. å°è£…ï¼šæŸ¥è¯¢å¤‡ä»½å†å²çš„æ ¸å¿ƒå‡½æ•°ï¼ˆå¤ç”¨æ€§å¼ºï¼‰
    function queryBackupHistory() {
        if (!currentModalHostname) return;
        
        // è·å–DOMå…ƒç´ 
        const historyLimit = document.getElementById('historyLimit');
        const tableBody = document.getElementById('backupHistoryTableBody');
        const countInfo = document.getElementById('historyCountInfo');
        const refreshBtn = document.getElementById('refreshHistoryBtn');
        
        // æ ¡éªŒlimitå‚æ•°
        let limit = parseInt(historyLimit.value.trim());
        if (isNaN(limit) || limit < 1 || limit > 100) {
            alert('è¯·è¾“å…¥1-30ä¹‹é—´çš„æœ‰æ•ˆæ•°å­—ï¼');
            historyLimit.value = 20;
            limit = 20;
        }
        
        // è®¾ç½®åŠ è½½çŠ¶æ€
        const originalBtnText = refreshBtn.textContent;
        refreshBtn.textContent = 'åˆ·æ–°ä¸­...';
        refreshBtn.disabled = true;
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-warning">æ­£åœ¨æŸ¥è¯¢å¤‡ä»½å†å²...</td></tr>';
        countInfo.textContent = 'æ€»è®°å½•æ•°ï¼šæŸ¥è¯¢ä¸­...';
        
        // è°ƒç”¨åç«¯ç¬¬å››ä¸ªAPIï¼ˆå…¼å®¹å¸¦è®¾å¤‡åå’Œlimitå‚æ•°ï¼‰
        const apiUrl = `/api/backup/history/${currentModalHostname}?limit=${limit}`;
        fetch(apiUrl)
            .then(response => {
                // å…ˆè§£æJSONï¼Œå†åˆ¤æ–­å“åº”çŠ¶æ€
                return response.json().then(data => {
                    if (!response.ok) {
                        throw new Error(data.error_msg || `è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
                    }
                    return data;
                });
            })
            .then(data => {
                // æ¸…ç©ºè¡¨æ ¼å†…å®¹
                tableBody.innerHTML = '';
                
                // å¤„ç†åç«¯è¿”å›ç»“æœï¼ˆåŒ¹é…ä½ çš„APIè¿”å›æ ¼å¼ï¼‰
                if (data.status === 'success' && data.history && data.history.length > 0) {
                    // æ¸²æŸ“å¤‡ä»½å†å²è¡¨æ ¼
                    data.history.forEach(record => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${record.id || 'æœªçŸ¥'}</td>
                            <td>${record.hostname || currentModalHostname}</td>
                            <td class="text-truncate" style="max-width: 300px;" title="${record.backup_path || 'æœªçŸ¥è·¯å¾„'}">
                                ${record.backup_path || 'æœªçŸ¥è·¯å¾„'}
                            </td>
                            <td>${record.start_time || record.backup_time || 'æœªçŸ¥æ—¶é—´'}</td>
                            <td>
                                ${record.status === 'success' || record.status === 'æˆåŠŸ' 
                                    ? '<span class="badge bg-success">æˆåŠŸ</span>' 
                                    : '<span class="badge bg-danger">å¤±è´¥</span>'}
                            </td>
                        `;
                        tableBody.appendChild(tr);
                    });
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    countInfo.textContent = `æ€»è®°å½•æ•°ï¼š${data.history_record || data.history.length} æ¡ï¼ˆå½“å‰æŸ¥è¯¢${limit}æ¡ï¼‰`;
                } else {
                    // æ— å¤‡ä»½å†å²è®°å½•
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">æš‚æ— å¤‡ä»½å†å²è®°å½•</td></tr>';
                    countInfo.textContent = 'æ€»è®°å½•æ•°ï¼š0 æ¡';
                }
            })
            .catch(error => {
                // å¤„ç†æŸ¥è¯¢å¼‚å¸¸
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">âŒ ${error.message}</td></tr>`;
                countInfo.textContent = 'æ€»è®°å½•æ•°ï¼šæŸ¥è¯¢å¤±è´¥';
                console.error('å¤‡ä»½å†å²æŸ¥è¯¢å¼‚å¸¸ï¼š', error);
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                refreshBtn.textContent = originalBtnText;
                refreshBtn.disabled = false;
            });
    }
    </script>

    <!-- ===================================== ä¼˜åŒ–ç‰ˆï¼šAIæŠ¥å‘ŠåŠŸèƒ½JSè„šæœ¬ ===================================== -->
    <script>
    // AIæŠ¥å‘Šçº¯æ–‡æœ¬ â†’ ç»“æ„åŒ–HTMLè½¬æ¢å‡½æ•°
    function formatReportToHtml(rawText) {
        if (!rawText || rawText.trim() === '') {
            return '<span class="report-empty">æš‚æ— æœ‰æ•ˆå¤‡ä»½æ•°æ®å¯ä¾›åˆ†æ</span>';
        }

        let html = rawText.trim();
        // 1. å¤„ç† **åŠ ç²—å†…å®¹** â†’ <strong>
        html = html.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
        // 2. å¤„ç† ç« èŠ‚æ ‡é¢˜ â†’ <h3>
        html = html.replace(/<strong>(\d+\. .*?)<\/strong>/g, "<h3>$1</h3>");
        // 3. å¤„ç† æ— åºåˆ—è¡¨ â†’ <ul><li>
        html = html.replace(/\n\*   (.*?)(?=\n|$)/g, "\n<li>$1</li>");
        html = html.replace(/(<li>.*?<\/li>)+/gs, "<ul>$&</ul>");
        // 4. å¤„ç† æœ‰åºåˆ—è¡¨ â†’ <ol><li>
        html = html.replace(/\n(\d+)\.  (.*?)(?=\n|$)/g, "\n<li>$2</li>");
        html = html.replace(/(<li>.*?<\/li>)+/gs, "<ol>$&</ol>");
        // 5. å¤„ç† æ³¨é‡Šå†…å®¹ â†’ <p class="report-note">
        html = html.replace(/\*\((æ³¨ï¼š.*?)\)\*/g, "<p class='report-note'>$1</p>");
        // 6. å¤„ç†æ¢è¡Œï¼Œä¼˜åŒ–æ’ç‰ˆ
        html = html.replace(/\n{2,}/g, "<br><br>");
        html = html.replace(/\n/g, " ");

        return `<div class="report-content-wrapper">${html}</div>`;
    }

    // ç”ŸæˆAIå¤‡ä»½æŠ¥å‘Šçš„æ ¸å¿ƒåŠŸèƒ½
    document.getElementById('generateReportBtn').addEventListener('click', function() {
        const generateBtn = this;
        const daysInput = document.getElementById('reportDays');
        const reportStatus = document.getElementById('report-status');
        const reportContent = document.getElementById('aiReportContent');
        const reportTime = document.getElementById('reportGenerateTime');
        
        let days = parseInt(daysInput.value.trim());
        if (isNaN(days) || days < 1 || days > 30) {
            alert('è¯·è¾“å…¥1-30ä¹‹é—´çš„æœ‰æ•ˆå¤©æ•°ï¼');
            daysInput.value = 7;
            return;
        }

        const originalBtnText = generateBtn.textContent;
        generateBtn.textContent = 'ç”Ÿæˆä¸­...';
        generateBtn.disabled = true;
        reportStatus.innerHTML = '<span class="text-warning">ğŸ“ æ­£åœ¨ç”ŸæˆAIè¿ç»´æŠ¥å‘Šï¼Œè¯·ç¨å€™...</span>';
        reportContent.innerHTML = '<span class="text-warning text-center d-block">æŠ¥å‘Šç”Ÿæˆä¸­...</span>';
        reportTime.textContent = '';

        const apiUrl = `/api/backup_record/ai/?days=${days}`;
        fetch(apiUrl)
            .then(response => {
                return response.json().then(data => {
                    if (!response.ok) {
                        throw new Error(data.message || data.error_detail || `è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
                    }
                    return data;
                });
            })
            .then(data => {
                if (data.code === 200) {
                    if (data.data && data.data !== '') {
                        reportStatus.innerHTML = '<span class="text-success">âœ… æŠ¥å‘Šç”ŸæˆæˆåŠŸï¼</span>';
                        const formattedHtml = formatReportToHtml(data.data);
                        reportContent.innerHTML = formattedHtml;
                        if (data.report_time) {
                            const formatTime = new Date(data.report_time).toLocaleString('zh-CN');
                            reportTime.textContent = `æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š${formatTime}`;
                        }
                    } else {
                        reportStatus.innerHTML = '<span class="text-muted">â„¹ï¸ æš‚æ— æœ‰æ•ˆæŠ¥å‘Šæ•°æ®</span>';
                        reportContent.innerHTML = '<span class="report-empty">æš‚æ— æœ‰æ•ˆå¤‡ä»½æ•°æ®å¯ä¾›åˆ†æ</span>';
                    }
                } else {
                    reportStatus.innerHTML = '<span class="text-muted">â„¹ï¸ æš‚æ— æœ‰æ•ˆæŠ¥å‘Šæ•°æ®</span>';
                    reportContent.innerHTML = '<span class="report-empty">æš‚æ— æœ‰æ•ˆå¤‡ä»½æ•°æ®å¯ä¾›åˆ†æ</span>';
                }
                console.log('AIæŠ¥å‘Šè¯¦ç»†ç»“æœ:', data);
            })
            .catch(error => {
                reportStatus.innerHTML = `<span class="text-danger">âŒ æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼</span>`;
                reportContent.innerHTML = `<span class="text-danger text-center d-block">${error.message}</span>`;
                console.error('AIæŠ¥å‘Šç”Ÿæˆå¼‚å¸¸ï¼š', error);
            })
            .finally(() => {
                generateBtn.textContent = originalBtnText;
                generateBtn.disabled = false;
            });
    });
    </script>

    <!-- ===================================== æ–°å¢ï¼šç³»ç»Ÿå¥åº·æ£€æŸ¥åŠŸèƒ½JSè„šæœ¬ ===================================== -->
    <script>
    document.getElementById('checkSystemHealthBtn').addEventListener('click', function() {
        const btn = this;
        const summaryDiv = document.getElementById('systemHealthSummary');
        const metricsContent = document.getElementById('systemMetricsContent');
        const serviceContent = document.getElementById('serviceStatusContent');

        const originalBtnText = btn.textContent;
        btn.textContent = 'æ£€æŸ¥ä¸­...';
        btn.disabled = true;

        summaryDiv.innerHTML = '<div class="d-flex justify-content-between align-items-center"><span class="fw-bold">æ•´ä½“çŠ¶æ€ï¼š<span class="text-warning">æ£€æŸ¥ä¸­...</span></span><span class="small text-muted">æ­£åœ¨è·å–ç³»ç»Ÿå¥åº·æ•°æ®...</span></div>';
        metricsContent.innerHTML = '<div class="text-center text-warning py-4"><div class="spinner-border spinner-border-sm me-2"></div>æ­£åœ¨æ”¶é›†ç³»ç»ŸæŒ‡æ ‡...</div>';
        serviceContent.innerHTML = '<div class="text-center text-warning py-4"><div class="spinner-border spinner-border-sm me-2"></div>æ­£åœ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€...</div>';

        fetch('/api/system/healthy')
            .then(response => {
                return response.json().then(data => {
                    if (!response.ok) {
                        throw new Error(data.message || `è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
                    }
                    return data;
                });
            })
            .then(data => {
                const healthyStatus = data.healthy;
                const timestamp = data.timestamp ? new Date(data.timestamp).toLocaleString('zh-CN') : 'æœªçŸ¥æ—¶é—´';
                const systemMetrics = data.system_metrics;
                const serviceStatus = data.service_status;

                let overallBadgeClass = 'bg-secondary';
                let overallText = 'æœªçŸ¥';

                if (healthyStatus === 'healthy') {
                    overallBadgeClass = 'bg-success';
                    overallText = 'å¥åº·';
                } else if (healthyStatus === 'degraded') {
                    overallBadgeClass = 'bg-warning text-dark';
                    overallText = 'é™çº§';
                } else if (healthyStatus === 'unhealthy') {
                    overallBadgeClass = 'bg-danger';
                    overallText = 'ä¸å¥åº·';
                }

                summaryDiv.innerHTML = `<div class="d-flex justify-content-between align-items-center"><span class="fw-bold">æ•´ä½“çŠ¶æ€ï¼š<span class="badge ${overallBadgeClass}">${overallText}</span></span><span class="small text-muted">æ£€æŸ¥æ—¶é—´ï¼š${timestamp}</span></div>`;

                if (systemMetrics && typeof systemMetrics === 'object') {
                    metricsContent.innerHTML = `
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center py-2">
                                        <small class="text-muted d-block">CPUä½¿ç”¨ç‡</small>
                                        <strong class="h5 mb-0">${systemMetrics.cpu_percent || 'N/A'}%</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center py-2">
                                        <small class="text-muted d-block">å†…å­˜ä½¿ç”¨ç‡</small>
                                        <strong class="h5 mb-0">${systemMetrics.memory_percent || 'N/A'}%</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center py-2">
                                        <small class="text-muted d-block">ç£ç›˜ä½¿ç”¨ç‡</small>
                                        <strong class="h5 mb-0">${systemMetrics.disk_percent || 'N/A'}%</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center py-2">
                                        <small class="text-muted d-block">å†…å­˜å·²ç”¨</small>
                                        <strong class="h5 mb-0">${systemMetrics.memory_used_gb || 'N/A'} GB</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center py-2">
                                        <small class="text-muted d-block">ç£ç›˜å·²ç”¨</small>
                                        <strong class="h5 mb-0">${systemMetrics.disk_used_gb || 'N/A'} GB</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center py-2">
                                        <small class="text-muted d-block">å†…å­˜æ€»é‡</small>
                                        <strong class="h5 mb-0">${systemMetrics.memory_total_gb || 'N/A'} GB</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (typeof systemMetrics === 'string') {
                    metricsContent.innerHTML = `<div class="alert alert-danger small mb-0">${systemMetrics}</div>`;
                } else {
                    metricsContent.innerHTML = '<div class="text-center text-muted py-4"><small>æ— æ³•è·å–ç³»ç»ŸæŒ‡æ ‡æ•°æ®</small></div>';
                }

                if (serviceStatus && typeof serviceStatus === 'object') {
                    let serviceHtml = '<div class="list-group list-group-flush">';
                    for (const [serviceName, status] of Object.entries(serviceStatus)) {
                        let badgeClass = 'bg-secondary';
                        let statusText = status;

                        if (status === 'healthy' || (typeof status === 'string' && status.includes('healthy'))) {
                            badgeClass = 'bg-success';
                            statusText = 'æ­£å¸¸';
                        } else if (typeof status === 'string' && status.includes('unhealthy')) {
                            badgeClass = 'bg-danger';
                            statusText = 'å¼‚å¸¸';
                        }

                        const serviceNames = {
                            'web_dashboard': 'Webä»ªè¡¨ç›˜',
                            'database': 'æ•°æ®åº“',
                            'nornir_engine': 'Nornirå¼•æ“'
                        };
                        const displayName = serviceNames[serviceName] || serviceName;

                        serviceHtml += `
                            <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                                <span>${displayName}</span>
                                <span class="badge ${badgeClass}">${statusText}</span>
                            </div>
                        `;
                    }
                    serviceHtml += '</div>';
                    serviceContent.innerHTML = serviceHtml;
                } else {
                    serviceContent.innerHTML = '<div class="text-center text-muted py-4"><small>æ— æ³•è·å–æœåŠ¡çŠ¶æ€æ•°æ®</small></div>';
                }
            })
            .catch(error => {
                summaryDiv.innerHTML = '<div class="d-flex justify-content-between align-items-center"><span class="fw-bold">æ•´ä½“çŠ¶æ€ï¼š<span class="badge bg-danger">æ£€æŸ¥å¤±è´¥</span></span><span class="small text-muted">è¯·ç¨åé‡è¯•</span></div>';
                metricsContent.innerHTML = `<div class="alert alert-danger small mb-0">è·å–ç³»ç»ŸæŒ‡æ ‡å¤±è´¥ï¼š${error.message}</div>`;
                serviceContent.innerHTML = `<div class="alert alert-danger small mb-0">è·å–æœåŠ¡çŠ¶æ€å¤±è´¥ï¼š${error.message}</div>`;
                console.error('ç³»ç»Ÿå¥åº·æ£€æŸ¥å¼‚å¸¸ï¼š', error);
            })
            .finally(() => {
                btn.textContent = originalBtnText;
                btn.disabled = false;
            });
    });
    </script>

    <!-- ===================================== æ ¸å¿ƒä¿®æ”¹ï¼šNornirå¹¶å‘å¥åº·æ£€æŸ¥æœ€ç»ˆè½åœ°ç‰ˆJS ===================================== -->
    <script>
    // åˆå§‹åŒ–Nornirç›¸å…³DOMå…ƒç´ å’Œæ¨¡æ€æ¡†
    const nornirSelectAll = document.getElementById('nornirSelectAll');
    const nornirTableSelectAll = document.getElementById('nornirTableSelectAll');
    const nornirSelectedCount = document.getElementById('nornirSelectedCount');
    const nornirBatchCheckBtn = document.getElementById('nornirBatchCheckBtn');
    const nornirDeviceCheckboxes = document.querySelectorAll('.nornirDeviceCheckbox');
    const nornirCheckResultModal = new bootstrap.Modal(document.getElementById('nornirCheckResultModal'));

    // 1. å…¨é€‰/å–æ¶ˆå…¨é€‰åŠŸèƒ½ï¼ˆé¡¶éƒ¨å…¨é€‰æ¡† + è¡¨æ ¼å†…å…¨é€‰æ¡†ï¼ŒåŒå‘åŒæ­¥ï¼‰
    function syncNornirSelectAllStatus() {
        const allChecked = Array.from(nornirDeviceCheckboxes).every(checkbox => checkbox.checked);
        const anyChecked = Array.from(nornirDeviceCheckboxes).some(checkbox => checkbox.checked);
        nornirSelectAll.checked = allChecked;
        nornirTableSelectAll.checked = allChecked;
        nornirBatchCheckBtn.disabled = !anyChecked;
        
        // æ›´æ–°é€‰ä¸­è®¾å¤‡è®¡æ•°
        const selectedCount = Array.from(nornirDeviceCheckboxes).filter(checkbox => checkbox.checked).length;
        nornirSelectedCount.textContent = `(å·²é€‰ï¼š${selectedCount} å°)`;
    }

    // é¡¶éƒ¨å…¨é€‰æ¡†äº‹ä»¶
    nornirSelectAll.addEventListener('change', function() {
        nornirDeviceCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        syncNornirSelectAllStatus();
    });

    // è¡¨æ ¼å†…å…¨é€‰æ¡†äº‹ä»¶ï¼ˆä¸é¡¶éƒ¨å…¨é€‰æ¡†åŒæ­¥ï¼‰
    nornirTableSelectAll.addEventListener('change', function() {
        nornirSelectAll.checked = this.checked;
        nornirDeviceCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        syncNornirSelectAllStatus();
    });

    // å•ä¸ªè®¾å¤‡å¤é€‰æ¡†äº‹ä»¶
    nornirDeviceCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', syncNornirSelectAllStatus);
    });

    // 2. å°è£…ï¼šè·å–é€‰ä¸­çš„è®¾å¤‡åˆ—è¡¨
    function getSelectedNornirDevices() {
        const selectedDevices = [];
        nornirDeviceCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                const hostname = checkbox.getAttribute('data-hostname');
                selectedDevices.push(hostname);
            }
        });
        return selectedDevices;
    }

    // 3. Nornirå¹¶å‘æ£€æŸ¥æ ¸å¿ƒåŠŸèƒ½ï¼ˆæœ€ç»ˆè½åœ°ç‰ˆï¼šå±•ç¤ºå®Œæ•´åŸå§‹å‘½ä»¤è¾“å‡ºï¼Œæ— æˆªå–ï¼‰
    nornirBatchCheckBtn.addEventListener('click', function() {
        const btn = this;
        const selectedDevices = getSelectedNornirDevices();
        if (selectedDevices.length === 0) {
            alert('è¯·å…ˆé€‰æ‹©éœ€è¦å¹¶å‘æ£€æŸ¥çš„è®¾å¤‡ï¼');
            return;
        }

        // åˆå§‹åŒ–æ¨¡æ€æ¡†å†…å®¹
        const resultTableBody = document.getElementById('nornirCheckResultTableBody');
        const summaryText = document.getElementById('nornirSummaryText');
        const successCount = document.getElementById('nornirSuccessCount');
        const failedCount = document.getElementById('nornirFailedCount');
        const totalCount = document.getElementById('nornirTotalCount');

        // è®¾ç½®åŠ è½½çŠ¶æ€
        const originalBtnText = btn.textContent;
        btn.textContent = 'æ£€æŸ¥ä¸­...';
        btn.disabled = true;
        summaryText.innerHTML = '<span class="text-warning">æ­£åœ¨æ‰§è¡Œå¹¶å‘å¥åº·æ£€æŸ¥ï¼Œè¯·ç¨å€™...</span>';
        successCount.textContent = 'æˆåŠŸï¼š0 å°';
        failedCount.textContent = 'å¤±è´¥ï¼š0 å°';
        totalCount.textContent = `æ€»è®¡ï¼š${selectedDevices.length} å°`;
        resultTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-warning">æ­£åœ¨æ‰§è¡Œå¹¶å‘æ£€æŸ¥ï¼Œè¯·å‹¿å…³é—­...</td></tr>';

        // æ‹¼æ¥è®¾å¤‡åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼Œç¬¦åˆåç«¯APIè¦æ±‚ï¼‰
        const devicesStr = selectedDevices.join(',');
        // è°ƒç”¨ä½ çš„ç¬¬6ä¸ªAPIï¼š/api/health/nornir-check
        const apiUrl = `/api/health/nornir-check?devices=${encodeURIComponent(devicesStr)}`;

        // å‘é€è¯·æ±‚è°ƒç”¨Nornirå¹¶å‘æ£€æŸ¥API
        fetch(apiUrl)
            .then(response => {
                // å…ˆè§£æJSONï¼Œå†åˆ¤æ–­å“åº”çŠ¶æ€ï¼ˆä¸ç°æœ‰JSé€»è¾‘å¯¹é½ï¼‰
                return response.json().then(data => {
                    if (!response.ok) {
                        throw new Error(data.error || `å¹¶å‘æ£€æŸ¥è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
                    }
                    return data;
                });
            })
            .then(data => {
                // æ§åˆ¶å°æ‰“å°å®Œæ•´è¿”å›æ•°æ®ï¼Œæ–¹ä¾¿è°ƒè¯•æŸ¥çœ‹
                console.log("åç«¯è¿”å›çš„å®Œæ•´Norniræ£€æŸ¥æ•°æ®ï¼š", data);
                
                // æ¸…ç©ºè¡¨æ ¼å†…å®¹
                resultTableBody.innerHTML = '';
                let successNum = 0;
                let failedNum = 0;

                // è§£æåç«¯è¿”å›ç»“æœï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼šç²¾å‡†æå–å®Œæ•´çš„version_resultå’Œinterface_resultï¼Œæ— æˆªå–ï¼‰
                if (data.success && Array.isArray(data.success)) {
                    // å¤„ç†æˆåŠŸè®¾å¤‡ï¼ˆæ ¸å¿ƒï¼šæå–åç«¯è¿”å›çš„å®Œæ•´å­—æ®µï¼Œä¿ç•™åŸå§‹æ ¼å¼ï¼‰
                    data.success.forEach(item => {
                        successNum++;
                        // é€å±‚æå–æ•°æ®ï¼Œå®Œå–„å®¹é”™å¤„ç†ï¼Œé¿å…é¡µé¢æŠ¥é”™
                        const deviceResult = item.result || {};
                        const deviceDetails = deviceResult.details || {};
                        
                        // ã€æ ¸å¿ƒä¿®æ”¹1ï¼šç²¾å‡†æå–åç«¯è¿”å›çš„å®Œæ•´å­—æ®µï¼Œæ— ä»»ä½•æˆªå–ã€‘
                        const fullVersionOutput = deviceDetails.version_result || "æ— ç‰ˆæœ¬æŸ¥è¯¢åŸå§‹è¾“å‡º";
                        const fullInterfaceOutput = deviceDetails.interface_result || "æ— æ¥å£æŸ¥è¯¢åŸå§‹è¾“å‡º";
                        
                        // ã€æ ¸å¿ƒä¿®æ”¹2ï¼šæ‹¼æ¥å®Œæ•´çš„åŸå§‹å‘½ä»¤è¾“å‡ºï¼Œæ¨¡æ‹Ÿè®¾å¤‡ç»ˆç«¯æ ¼å¼ã€‘
                        const fullRawCommandOutput = [
                            "==================== è®¾å¤‡åŸå§‹å‘½ä»¤è¾“å‡ºå¼€å§‹ ====================",
                            "",
                            "ã€å‘½ä»¤ï¼šdisplay versionã€‘",
                            fullVersionOutput,
                            "",
                            "ã€å‘½ä»¤ï¼šdisplay interface briefã€‘",
                            fullInterfaceOutput,
                            "",
                            "==================== è®¾å¤‡åŸå§‹å‘½ä»¤è¾“å‡ºç»“æŸ ===================="
                        ].join('\n');

                        // ã€æ ¸å¿ƒä¿®æ”¹3ï¼šæ¸²æŸ“å®Œæ•´è¾“å‡ºï¼Œä¼˜åŒ–æ»šåŠ¨å’Œæ ·å¼ï¼Œæ— å‰ç«¯æˆªå–ã€‘
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${item.hostname || deviceResult.device_name || 'æœªçŸ¥è®¾å¤‡'}</td>
                            <td><span class="badge bg-success">æ£€æŸ¥æˆåŠŸ</span></td>
                            <td>
                                <pre class="raw-command-output bg-light p-3 rounded mb-0" style="max-height: 400px; overflow-y: auto;">${fullRawCommandOutput}</pre>
                            </td>
                            <td>${new Date().toLocaleString('zh-CN')}</td>
                        `;
                        resultTableBody.appendChild(tr);
                    });
                }

                if (data.failed && Array.isArray(data.failed)) {
                    // å¤„ç†å¤±è´¥è®¾å¤‡ï¼ˆä¿ç•™åŸå§‹é”™è¯¯ä¿¡æ¯ï¼‰
                    data.failed.forEach(item => {
                        failedNum++;
                        const errorRaw = item.error || item.raw_error || 'æœªçŸ¥æ£€æŸ¥å¤±è´¥åŸå› ';
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${item.hostname || 'æœªçŸ¥è®¾å¤‡'}</td>
                            <td><span class="badge bg-danger">æ£€æŸ¥å¤±è´¥</span></td>
                            <td>
                                <pre class="raw-command-output bg-light p-3 rounded mb-0 text-danger" style="max-height: 150px; overflow-y: auto;">${errorRaw}</pre>
                            </td>
                            <td>${new Date().toLocaleString('zh-CN')}</td>
                        `;
                        resultTableBody.appendChild(tr);
                    });
                }

                // æ›´æ–°æ±‡æ€»ç»Ÿè®¡
                successCount.textContent = `æˆåŠŸï¼š${successNum} å°`;
                failedCount.textContent = `å¤±è´¥ï¼š${failedNum} å°`;
                totalCount.textContent = `æ€»è®¡ï¼š${selectedDevices.length} å°`;
                
                if (failedNum === 0 && successNum > 0) {
                    summaryText.innerHTML = '<span class="text-success">âœ… æ‰€æœ‰é€‰ä¸­è®¾å¤‡å¹¶å‘æ£€æŸ¥å…¨éƒ¨æˆåŠŸï¼</span>';
                } else if (failedNum > 0) {
                    summaryText.innerHTML = `<span class="text-warning">âš ï¸ å¹¶å‘æ£€æŸ¥å®Œæˆï¼Œéƒ¨åˆ†è®¾å¤‡æ£€æŸ¥å¤±è´¥ï¼ˆå¤±è´¥ï¼š${failedNum} å°ï¼‰</span>`;
                } else {
                    summaryText.innerHTML = '<span class="text-muted">â„¹ï¸ æš‚æ— è®¾å¤‡æ£€æŸ¥ç»“æœ</span>';
                }

                // æ˜¾ç¤ºç»“æœæ¨¡æ€æ¡†
                nornirCheckResultModal.show();
            })
            .catch(error => {
                // æ•è·ç½‘ç»œæˆ–æœªçŸ¥å¼‚å¸¸
                resultTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">âŒ ${error.message}</td></tr>`;
                summaryText.innerHTML = '<span class="text-danger">âŒ å¹¶å‘æ£€æŸ¥è¯·æ±‚å¼‚å¸¸ï¼</span>';
                console.error('Nornirå¹¶å‘æ£€æŸ¥å¼‚å¸¸ï¼š', error);
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                btn.textContent = originalBtnText;
                btn.disabled = false;
            });
    });

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–é€‰ä¸­çŠ¶æ€
    document.addEventListener('DOMContentLoaded', syncNornirSelectAllStatus);
    </script>
</body>
</html>