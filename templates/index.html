<!DOCTYPE html>
<html>
<head>
    <title>æˆ‘çš„NetDevOpså·¥å…·ç®±</title>
    <!-- å¼•å…¥ Bootstrap æ ·å¼ï¼Œä¿è¯é¡µé¢ç¾è§‚ -->
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* è½»å¾®ä¼˜åŒ–é¡µé¢è§†è§‰ï¼Œé¿å…çº¯ç™½å•è°ƒï¼Œä¸ç ´å Bootstrap åŸæœ‰é£æ ¼ */
        body {
            background-color: #f8f9fa;
        }
        .card-header {
            background-color: #e9f5ff;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- é¡µé¢æ ‡é¢˜åŒºåŸŸ -->
        <h1 class="text-primary">ğŸ› ï¸ NetDevOpså·¥å…·ç®±ä»ªè¡¨ç›˜</h1>
        <p class="text-muted">è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€ä¸ªè‡ªåŠ¨åŒ–è¿ç»´Webç•Œé¢ï¼ï¼ˆæ— éœ€ä¿®æ”¹Pythonè„šæœ¬ï¼‰</p>

        <!-- ã€ä»»åŠ¡3æ–°å¢ï¼šAPIæœåŠ¡çŠ¶æ€å¡ç‰‡ã€‘æ”¾åœ¨è®¾å¤‡åˆ—è¡¨å¡ç‰‡ä¸Šæ–¹ï¼Œæ ·å¼ä¸åŸæœ‰é¡µé¢ç»Ÿä¸€ -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ”Œ APIæœåŠ¡çŠ¶æ€</h5>
                        <p id="api-status">æ£€æŸ¥ä¸­...</p>
                        <button id="refresh-api-btn" onclick="checkApiStatus()" class="btn btn-sm btn-info">åˆ·æ–°çŠ¶æ€</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è®¾å¤‡åˆ—è¡¨å¡ç‰‡ -->
        <div class="card mt-4 shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">ğŸ–§ è®¾å¤‡çŠ¶æ€æ€»è§ˆ</h5>
            </div>
            <div class="card-body bg-white">
                <!-- å“åº”å¼è¡¨æ ¼ï¼Œæ”¯æŒå°å±å¹•è‡ªé€‚åº” -->
                <table class="table table-hover table-striped align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>è®¾å¤‡å</th>
                            <th>IPåœ°å€</th>
                            <th>è®¾å¤‡ç±»å‹</th>
                            <th>è®¾å¤‡çŠ¶æ€</th>
                            <!-- ã€æ–°å¢1ï¼šå¤‡ä»½çŠ¶æ€åˆ—ã€‘ä¸“é—¨å±•ç¤ºå¤‡ä»½ç»“æœï¼Œä¸ç ´ååŸæœ‰è®¾å¤‡çŠ¶æ€ -->
                            <th>å¤‡ä»½çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- å¾ªç¯éå† Python è„šæœ¬ä¼ é€’çš„ devices åˆ—è¡¨ï¼Œæ— éœ€ä¿®æ”¹ -->
                        {% for device in devices %}
                        <tr>
                            <!-- å¯¹åº” Python è„šæœ¬ä¸­çš„ device_name å­—æ®µï¼ˆSW1/SW2 ç­‰ï¼‰ -->
                            <td>{{ device.device_name }}</td>
                            <!-- å¯¹åº” Python è„šæœ¬ä¸­çš„ host å­—æ®µï¼ˆè®¾å¤‡ IP åœ°å€ï¼‰ -->
                            <td>{{ device.host }}</td>
                            <!-- å¯¹åº” Python è„šæœ¬ä¸­çš„ device_type å­—æ®µï¼ˆhp_comwareï¼‰ï¼ŒåŠ è½»å¾®ç¾åŒ– -->
                            <td>
                                <span class="badge bg-info text-dark">{{ device.device_type }}</span>
                            </td>
                            <!-- ã€ä¿ç•™ã€‘è®¾å¤‡çŠ¶æ€åˆ—ï¼Œå¸¦ device-status ç±»å -->
                            <td class="device-status">
                                {% if device.status == 'åœ¨çº¿' %}
                                <span class="badge bg-success">åœ¨çº¿</span>
                                {% else %}
                                <span class="badge bg-danger">ç¦»çº¿</span>
                                {% endif %}
                            </td>
                            <!-- ã€æ–°å¢2ï¼šå¤‡ä»½çŠ¶æ€å•å…ƒæ ¼ã€‘å¸¦ backup-status ç±»åï¼Œä¾›JSæ›´æ–°å¤‡ä»½ç»“æœ -->
                            <td class="backup-status">
                                <span class="badge bg-secondary">æœªå¤‡ä»½</span>
                            </td>
                            <!-- ã€ä¿®æ”¹ï¼šæ“ä½œåˆ—æ–°å¢å¤‡ä»½æŒ‰é’®ã€‘ä¸å¥åº·æ£€æŸ¥æŒ‰é’®å¹¶æ’ï¼Œæ ·å¼åè°ƒ -->
                            <td>
                                <!-- å¥åº·æ£€æŸ¥æŒ‰é’®ï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼‰ -->
                                <button class="btn btn-sm btn-outline-primary health-check-btn" data-hostname="{{ device.device_name }}">
                                    å¥åº·æ£€æŸ¥
                                </button>
                                <!-- å¤‡ä»½æŒ‰é’®ï¼ˆæ–°å¢ï¼Œæ ·å¼åè°ƒï¼Œå¸¦ä¸“å±ç±»åå’Œæ•°æ®å±æ€§ï¼‰ -->
                                <button class="btn btn-sm btn-outline-secondary backup-btn ms-1" data-hostname="{{ device.device_name }}">
                                    å¤‡ä»½è®¾å¤‡
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- é¡µè„šåŒºåŸŸï¼Œæ˜¾ç¤ºè®¾å¤‡æ€»æ•° -->
        <footer class="mt-4 text-center text-muted">
            <small>ç‰ˆæœ¬ 0.5.0 | åŸºäºFlaskæ„å»º | è®¾å¤‡æ€»æ•°: {{ devices|length }} å°</small>
        </footer>
    </div>

   <!-- ã€ä¿ç•™ã€‘å¥åº·æ£€æŸ¥åŠŸèƒ½JSè„šæœ¬ï¼ˆæ— éœ€ä¿®æ”¹ï¼Œä¸åç«¯è¿”å›`ok`çŠ¶æ€åŒ¹é…ï¼‰ -->
<script>
// ä¸ºæ‰€æœ‰â€œå¥åº·æ£€æŸ¥â€æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
document.querySelectorAll('.health-check-btn').forEach(button => {
    button.addEventListener('click', function() {
        // 1. è·å–æŒ‰é’®ç»‘å®šçš„è®¾å¤‡åå’Œå½“å‰è¡Œçš„çŠ¶æ€å•å…ƒæ ¼
        const hostname = this.getAttribute('data-hostname');
        const statusCell = this.closest('tr').querySelector('.device-status');
        
        // 2. ç‚¹å‡»åç«‹å³æ›´æ–°æŒ‰é’®å’ŒçŠ¶æ€ï¼Œç»™å‡ºåŠ è½½åé¦ˆï¼ˆé˜²æ­¢é‡å¤ç‚¹å‡»ï¼‰
        const originalText = this.textContent;
        this.textContent = 'æ£€æŸ¥ä¸­...';
        this.disabled = true;
        statusCell.innerHTML = '<span class="badge bg-warning">æ£€æŸ¥ä¸­</span>';
        
        // 3. è°ƒç”¨åç«¯å¥åº·æ£€æŸ¥API
        fetch(`/api/health/${hostname}`)
            // å¤„ç†é200çŠ¶æ€ç 
            .then(response => {
                if (!response.ok) {
                    throw new Error(`è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // ä¸åç«¯çº¦å®šï¼šå¥åº·æ£€æŸ¥æˆåŠŸè¿”å› status: "ok"ï¼ˆæ— éœ€ä¿®æ”¹ï¼ŒåŒ¹é…åç«¯ï¼‰
                if (data.status && data.status.toLowerCase() === 'æˆåŠŸ') {
                    // æ”¹è‰¯ç‚¹1ï¼šå…ˆæ˜¾ç¤ºã€Œæ£€æŸ¥æˆåŠŸã€åé¦ˆï¼ˆçŸ­æš‚æç¤ºç”¨æˆ·ï¼‰ï¼Œå†æ¢å¤ã€Œåœ¨çº¿ã€é•¿æœŸçŠ¶æ€
                    // æ­¥éª¤1ï¼šç«‹å³æ¸²æŸ“ã€Œæœ¬æ¬¡æ£€æŸ¥æˆåŠŸã€
                    statusCell.innerHTML = '<span class="badge bg-info">æ£€æŸ¥æˆåŠŸ</span>';
                    // æ­¥éª¤2ï¼š3ç§’åè‡ªåŠ¨æ¢å¤ã€Œåœ¨çº¿ã€çŠ¶æ€ï¼ˆå…¼é¡¾ç”¨æˆ·åé¦ˆå’Œé•¿æœŸçŠ¶æ€å±•ç¤ºï¼Œå¯è°ƒæ•´å»¶æ—¶ï¼‰
                    setTimeout(() => {
                        statusCell.innerHTML = '<span class="badge bg-success">åœ¨çº¿</span>';
                    }, 3000);
                } else {
                    // æ”¹è‰¯ç‚¹2ï¼šéæˆåŠŸçŠ¶æ€ç›´æ¥æ¸²æŸ“ã€Œå¼‚å¸¸ã€ï¼Œæ— å»¶æ—¶ï¼ˆæ˜ç¡®è®¾å¤‡æ•…éšœï¼‰
                    statusCell.innerHTML = '<span class="badge bg-danger">å¼‚å¸¸</span>';
                }
                console.log('å¥åº·æ£€æŸ¥è¯¦ç»†ç»“æœ:', data);
            })
            // æ•è·å¼‚å¸¸
            .catch(error => {
                statusCell.innerHTML = '<span class="badge bg-secondary">å¤±è´¥</span>';
                console.error('å¥åº·æ£€æŸ¥è¯·æ±‚å¤±è´¥:', error);
            })
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            .finally(() => {
                this.textContent = originalText;
                this.disabled = false;
            });
    });
});
</script>

    <!-- ã€ä¿®æ”¹æ ¸å¿ƒã€‘å¤‡ä»½åŠŸèƒ½JSè„šæœ¬ï¼ˆå¯¹é½åç«¯è¿”å›çš„ä¸­æ–‡çŠ¶æ€+è¯¦ç»†å­—æ®µï¼‰ -->
    <script>
    // ä¸ºæ‰€æœ‰â€œå¤‡ä»½è®¾å¤‡â€æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.backup-btn').forEach(button => {
        button.addEventListener('click', function() {
            // 1. è·å–æŒ‰é’®ç»‘å®šçš„è®¾å¤‡åå’Œå½“å‰è¡Œçš„å¤‡ä»½çŠ¶æ€å•å…ƒæ ¼
            const hostname = this.getAttribute('data-hostname');
            const backupCell = this.closest('tr').querySelector('.backup-status');
            
            // 2. ç‚¹å‡»åç«‹å³æ›´æ–°æŒ‰é’®å’Œå¤‡ä»½çŠ¶æ€ï¼Œç»™å‡ºåŠ è½½åé¦ˆ
            const originalText = this.textContent;
            this.textContent = 'å¤‡ä»½ä¸­...';
            this.disabled = true;
            backupCell.innerHTML = '<span class="badge bg-warning">å¤‡ä»½ä¸­</span>';
            
            // 3. è°ƒç”¨åç«¯å¤‡ä»½APIï¼ˆå¯¹åº”åç«¯ /api/backup/<hostname>ï¼‰
            fetch(`/api/backup/${hostname}`)
                // ã€ä¿®æ”¹1ï¼šå…ˆè§£æJSONï¼Œå†åˆ¤æ–­å“åº”æ˜¯å¦æ­£å¸¸ï¼Œæ‹¿åˆ°åç«¯è¯¦ç»†ä¿¡æ¯ã€‘
                .then(response => {
                    // æ— è®ºå“åº”æ˜¯å¦okï¼Œå…ˆè§£æåç«¯è¿”å›çš„JSONæ•°æ®ï¼ˆåŒ¹é…åç«¯è¿”å›çš„è¯¦ç»†å­—æ®µï¼‰
                    return response.json().then(data => {
                        if (!response.ok) {
                            // æŠŠåç«¯è¿”å›çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯å¸¦å…¥å¼‚å¸¸
                            throw new Error(data.message || `å¤‡ä»½è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
                        }
                        return data;
                    });
                })
                // å¤„ç†è§£æåçš„å¤‡ä»½ç»“æœï¼Œæ›´æ–°é¡µé¢çŠ¶æ€
                .then(data => {
                    // ã€ä¿®æ”¹2ï¼šåˆ¤æ–­åç«¯è¿”å›çš„ä¸­æ–‡çŠ¶æ€â€œæˆåŠŸâ€ï¼ˆæ›¿æ¢åŸè‹±æ–‡successåˆ¤æ–­ï¼‰ã€‘
                    if (data.status && data.status === 'æˆåŠŸ') {
                        // ã€ä¿®æ”¹3ï¼šå±•ç¤ºåç«¯è¿”å›çš„å¤‡ä»½è·¯å¾„ï¼Œæ›´ç›´è§‚ã€‘
                        const successHtml = `
                            <span class="badge bg-success">å¤‡ä»½æˆåŠŸ</span>
                            <small class="text-muted d-block mt-1">
                                å¤‡ä»½è·¯å¾„ï¼š${data.backup_path || 'æœªçŸ¥è·¯å¾„'}
                            </small>
                        `;
                        backupCell.innerHTML = successHtml;
                    } else {
                        // å±•ç¤ºåç«¯è¿”å›çš„å¤±è´¥æ¶ˆæ¯
                        backupCell.innerHTML = `<span class="badge bg-danger">å¤‡ä»½å¤±è´¥ï¼š${data.message || 'æœªçŸ¥é”™è¯¯'}</span>`;
                    }
                    // æ§åˆ¶å°æ‰“å°è¯¦ç»†å¤‡ä»½ç»“æœï¼ˆå¼€å‘è€…è°ƒè¯•ç”¨ï¼ŒæŸ¥çœ‹åç«¯è¿”å›çš„æ‰€æœ‰å­—æ®µï¼‰
                    console.log('å¤‡ä»½è¯¦ç»†ç»“æœ:', data);
                })
                // æ•è·å¤‡ä»½è¯·æ±‚å¼‚å¸¸ï¼ˆæœåŠ¡å™¨å®•æœºã€APIä¸å­˜åœ¨ã€åç«¯è¿”å›çš„é”™è¯¯ç­‰ï¼‰
                .catch(error => {
                    // å±•ç¤ºè¯¦ç»†å¼‚å¸¸ä¿¡æ¯ï¼ˆæ¥è‡ªåç«¯æˆ–è¯·æ±‚é”™è¯¯ï¼‰
                    backupCell.innerHTML = `<span class="badge bg-secondary">âŒ ${error.message}</span>`;
                    console.error('å¤‡ä»½è¯·æ±‚å¼‚å¸¸:', error);
                })
                // æ— è®ºæˆåŠŸ/å¤±è´¥ï¼Œæœ€ç»ˆæ¢å¤å¤‡ä»½æŒ‰é’®åŸå§‹çŠ¶æ€
                .finally(() => {
                    this.textContent = originalText;
                    this.disabled = false;
                });
        });
    });
    </script>

    <!-- ã€å¾®è°ƒã€‘APIçŠ¶æ€æ£€æŸ¥JSè„šæœ¬ï¼ˆå…¼å®¹åç«¯è¿”å›çš„ä¸­æ–‡å¼‚å¸¸çŠ¶æ€ï¼‰ -->
    <script>
    // æ£€æŸ¥APIçŠ¶æ€çš„å‡½æ•°
    function checkApiStatus() {
        const statusElement = document.getElementById('api-status');
        const refreshBtn = document.getElementById('refresh-api-btn'); // è·å–åˆ·æ–°æŒ‰é’®
        
        // 1. ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»ï¼Œæ›´æ–°æŒ‰é’®æ–‡å­—
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = 'åˆ·æ–°ä¸­...';
        statusElement.innerHTML = '<span class="text-warning">æ£€æŸ¥ä¸­...</span>';
        
        fetch('/api/service_status')
            .then(response => {
                // å…ˆè§£æJSONï¼Œå†åˆ¤æ–­å“åº”æ˜¯å¦æˆåŠŸ
                return response.json().then(data => {
                    if (!response.ok) {
                        throw new Error(`APIè¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
                    }
                    return data;
                });
            })
            .then(data => {
                // 2. å¢åŠ æ•°æ®æ ¼å¼æ ¡éªŒï¼Œé˜²æ­¢åç«¯è¿”å›å¼‚å¸¸æ•°æ®ï¼ˆæå‡å¥å£®æ€§ï¼‰
                if (!data || !data.status) {
                    statusElement.innerHTML = '<span class="badge bg-secondary">â“ æœªçŸ¥çŠ¶æ€ï¼ˆæ•°æ®æ ¼å¼å¼‚å¸¸ï¼‰</span>';
                    return;
                }
                
                // åŒ¹é…åç«¯è¿”å›çš„æ­£å¸¸çŠ¶æ€'healthy'
                if (data.status === 'healthy') {
                    statusElement.innerHTML = '<span class="badge bg-success">âœ… æœåŠ¡æ­£å¸¸</span>';
                } else {
                    // ã€å¾®è°ƒï¼šå…¼å®¹åç«¯è¿”å›çš„ä¸­æ–‡å¼‚å¸¸çŠ¶æ€ï¼Œå±•ç¤ºè¯¦ç»†æ¶ˆæ¯ã€‘
                    const errorMsg = data.message || 'æœªçŸ¥å¼‚å¸¸';
                    statusElement.innerHTML = `<span class="badge bg-warning">âš ï¸ æœåŠ¡å¼‚å¸¸: ${errorMsg}</span>`;
                }
            })
            .catch(error => {
                statusElement.innerHTML = '<span class="badge bg-danger">âŒ è¯·æ±‚å¤±è´¥ï¼ˆæ— æ³•è¿æ¥APIï¼‰</span>';
                // 3. æ‰“å°é”™è¯¯ä¿¡æ¯ï¼Œæ–¹ä¾¿å¼€å‘è€…è°ƒè¯•ï¼ˆç”¨æˆ·ä¸å¯è§ï¼Œä¸å½±å“ä½“éªŒï¼‰
                console.error('APIçŠ¶æ€æ£€æŸ¥å¤±è´¥è¯¦æƒ…ï¼š', error);
            })
            .finally(() => {
                // 4. æ— è®ºæˆåŠŸå¤±è´¥ï¼Œæœ€ç»ˆå¯ç”¨æŒ‰é’®ï¼Œæ¢å¤æŒ‰é’®æ–‡å­—ï¼ˆå’Œå…¶ä»–åŠŸèƒ½é€»è¾‘ä¸€è‡´ï¼‰
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = 'åˆ·æ–°çŠ¶æ€';
            });
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡APIçŠ¶æ€ï¼ˆæ— éœ€æ‰‹åŠ¨ç‚¹å‡»ï¼Œæå‡ä¾¿æ·æ€§ï¼‰
    document.addEventListener('DOMContentLoaded', checkApiStatus);
    </script>
</body>
</html>